<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Smash-Style Test (FIXED)</title>
<style>
body {
  margin: 0;
  background: black;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
canvas {
  background: #111;
  border: 2px solid white;
}
</style>
</head>
<body>

<canvas id="game" width="900" height="500"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* =====================
   INPUT
===================== */
const keys = {};
window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

/* =====================
   PLAYER FACTORY
===================== */
function makePlayer(x, color, controls) {
  return {
    x, y: 300,
    w: 30, h: 55,
    vx: 0, vy: 0,
    speed: 4,
    facing: 1,
    onGround: false,
    percent: 0,
    meter: 0,
    attacking: false,
    controls,
    color
  };
}

const p1 = makePlayer(250, "red", {
  left: "a", right: "d", jump: "w",
  attack: " ", ultimate: "q"
});

const p2 = makePlayer(600, "cyan", {
  left: "arrowleft", right: "arrowright", jump: "arrowup",
  attack: "alt", ultimate: "shift"
});

/* =====================
   PHYSICS
===================== */
const gravity = 0.7;
const groundY = 380;

/* =====================
   FIREBALLS
===================== */
const fireballs = [];

function spawnFireball(owner, target) {
  fireballs.push({
    x: owner.x + owner.facing * 30,
    y: owner.y + 25,
    r: 16,
    target,
    life: 240
  });
}

/* =====================
   HIT CHECK
===================== */
function hit(a, b) {
  return a.x < b.x + b.w &&
         a.x + a.w > b.x &&
         a.y < b.y + b.h &&
         a.y + a.h > b.y;
}

/* =====================
   ATTACK
===================== */
function attack(attacker, target) {
  const box = {
    x: attacker.x + attacker.facing * attacker.w,
    y: attacker.y + 20,
    w: 25,
    h: 20
  };

  if (hit(box, target)) {
    target.percent += 8;
    target.vx = attacker.facing * (4 + target.percent * 0.03);
    target.vy = -6;
    attacker.meter = Math.min(100, attacker.meter + 20);
  }
}

/* =====================
   UPDATE PLAYER
===================== */
function updatePlayer(p, enemy) {
  const c = p.controls;

  if (keys[c.left]) {
    p.vx = -p.speed;
    p.facing = -1;
  } else if (keys[c.right]) {
    p.vx = p.speed;
    p.facing = 1;
  }

  if (keys[c.jump] && p.onGround) {
    p.vy = -12;
    p.onGround = false;
  }

  if (keys[c.attack]) {
    attack(p, enemy);
  }

  if (keys[c.ultimate] && p.meter >= 100) {
    spawnFireball(p, enemy);
    p.meter = 0;
  }

  p.vy += gravity;
  p.x += p.vx;
  p.y += p.vy;
  p.vx *= 0.8;

  if (p.y + p.h >= groundY) {
    p.y = groundY - p.h;
    p.vy = 0;
    p.onGround = true;
  }

  if (p.y > canvas.height + 200) {
    p.x = Math.random() * 600 + 100;
    p.y = 0;
    p.percent = 0;
  }
}

/* =====================
   DRAW PLAYER
===================== */
function drawPlayer(p) {
  ctx.save();
  ctx.translate(p.x + p.w / 2, p.y + p.h / 2);
  ctx.scale(p.facing, 1);

  ctx.strokeStyle = p.color;
  ctx.lineWidth = 4;

  // Head
  ctx.beginPath();
  ctx.arc(0, -18, 8, 0, Math.PI * 2);
  ctx.stroke();

  // Torso
  ctx.beginPath();
  ctx.moveTo(0, -10);
  ctx.lineTo(0, 20);
  ctx.stroke();

  // Arms
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(18, 8);
  ctx.moveTo(0, 4);
  ctx.lineTo(-12, 12);
  ctx.stroke();

  // Legs
  ctx.beginPath();
  ctx.moveTo(0, 20);
  ctx.lineTo(8, 42);
  ctx.moveTo(0, 20);
  ctx.lineTo(-8, 42);
  ctx.stroke();

  ctx.restore();

  ctx.fillStyle = "white";
  ctx.fillText(Math.floor(p.percent) + "%", p.x, p.y - 6);

  ctx.fillStyle = "cyan";
  ctx.fillRect(p.x, p.y + p.h + 4, p.meter / 2, 4);
}

/* =====================
   FIREBALL UPDATE
===================== */
function updateFireballs() {
  for (let i = fireballs.length - 1; i >= 0; i--) {
    const f = fireballs[i];
    const dx = f.target.x - f.x;
    const dy = f.target.y - f.y;
    const d = Math.hypot(dx, dy) || 1;

    f.x += dx / d * 4;
    f.y += dy / d * 4;
    f.life--;

    if (hit({ x: f.x - f.r, y: f.y - f.r, w: f.r * 2, h: f.r * 2 }, f.target)) {
      f.target.percent += 15;
      f.target.vx += dx / d * 6;
      f.target.vy = -8;
      fireballs.splice(i, 1);
      continue;
    }

    if (f.life <= 0) fireballs.splice(i, 1);
  }
}

function drawFireballs() {
  fireballs.forEach(f => {
    ctx.fillStyle = "orange";
    ctx.beginPath();
    ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
    ctx.fill();
  });
}

/* =====================
   GAME LOOP
===================== */
function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Ground
  ctx.fillStyle = "#444";
  ctx.fillRect(0, groundY, canvas.width, 10);

  updatePlayer(p1, p2);
  updatePlayer(p2, p1);
  updateFireballs();

  drawPlayer(p1);
  drawPlayer(p2);
  drawFireballs();

  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
