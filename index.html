<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Shift Horror - 10 Nights</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
  body, html { margin:0; padding:0; overflow:hidden; background:#000; font-family:'Courier New', monospace; color:#0f0; }
  canvas { display:block; }
  #ui {
    position:absolute; inset:0; pointer-events:none; color:#0f0; text-shadow:0 0 6px #0f0; font-size:1.4rem; padding:20px; z-index:10;
  }
  #phone {
    position:absolute; bottom:40px; left:50%; transform:translateX(-50%);
    width:360px; height:720px; background:#0a0a0a; border:6px solid #222; border-radius:36px;
    padding:30px; box-shadow:0 0 60px #000; display:none; pointer-events:all; overflow-y:auto; font-size:1.2rem; line-height:1.6; z-index:20;
  }
  #phone.show { display:block; }
  #time { position:absolute; top:20px; right:30px; font-size:3rem; text-shadow:0 0 12px #0f0; }
  #hud { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); font-size:2rem; }
  #shift-message {
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    font-size:5rem; text-align:center; color:#f00; text-shadow:0 0 20px #f00; display:none;
  }
  #end-shift {
    position:absolute; inset:0; background:rgba(0,0,0,0.95); color:#f00; font-size:6rem; text-align:center; padding-top:40vh; display:none;
  }
</style>
</head>
<body>

<div id="ui">
  <div id="time">04:00</div>
  <div id="hud"></div>
</div>

<div id="phone">
  <h2>Phone</h2>
  <div id="mission-text"></div>
</div>

<div id="shift-message"></div>
<div id="end-shift">YOUR SHIFT IS OVER<br>GO HOME</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/controls/PointerLockControls.min.js"></script>
<script>
// =============== CONFIG ===============
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x001100);
scene.fog = new THREE.FogExp2(0x001100, 0.06);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: false });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(0.8); // Low-res retro look
document.body.appendChild(renderer.domElement);

const controls = new THREE.PointerLockControls(camera, renderer.domElement);
scene.add(controls.getObject());

camera.position.set(0, 1.8, 0);

// Lighting
scene.add(new THREE.AmbientLight(0x222222, 0.8));
const redLight = new THREE.PointLight(0xff0040, 1.5, 30);
redLight.position.set(5, 5, -5);
scene.add(redLight);

// =============== INPUT ===============
const keys = {};
window.addEventListener('keydown', e => {
  keys[e.key.toLowerCase()] = true;
  if (e.key === 'Shift') togglePhone();
});
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

// Lock pointer on click
renderer.domElement.addEventListener('click', () => controls.lock());

// =============== GAME STATE ===============
let shift = parseInt(localStorage.getItem('currentShift') || '1');
let timeLeft = 240;
let gameState = 'shift'; // shift / end-shift / driving / next-shift
let pistolEquipped = false;
let crouching = false;

const missions = [
  "", // 0
  "Get all the children into their corresponding Class room",
  "get all the children into their corresponding class room...",
  "children in classroom",
  "classroom",
  "children",
  "I see you...",
  "",
  "I know who you are...and i'm not afraid...",
  "aoidhfa;fhoapdifhvnaosd;pfui",
  "In a next life, i'll be waiting"
];

function updateMissionText() {
  document.getElementById('mission-text').innerHTML = `<strong>Night ${shift} Mission:</strong><br><br>${missions[shift]}`;
}
updateMissionText();

// =============== OFFICE 3D ===============
function createOffice() {
  // Floor
  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(40, 40),
    new THREE.MeshBasicMaterial({ color: 0x111133 })
  );
  floor.rotation.x = -Math.PI/2;
  scene.add(floor);

  // Walls (retro colors)
  const wallMat = new THREE.MeshBasicMaterial({ color: 0x004433 });
  scene.add(new THREE.Mesh(new THREE.BoxGeometry(40, 8, 0.5), wallMat).translateZ(-20));
  scene.add(new THREE.Mesh(new THREE.BoxGeometry(40, 8, 0.5), wallMat).translateZ(20));
  scene.add(new THREE.Mesh(new THREE.BoxGeometry(0.5, 8, 40), wallMat).translateX(-20));
  scene.add(new THREE.Mesh(new THREE.BoxGeometry(0.5, 8, 40), wallMat).translateX(20));

  // Desk
  const desk = new THREE.Mesh(
    new THREE.BoxGeometry(6, 2, 3),
    new THREE.MeshBasicMaterial({ color: 0x442200 })
  );
  desk.position.set(0, 1, -8);
  scene.add(desk);

  // Monitor
  const monitor = new THREE.Mesh(
    new THREE.BoxGeometry(2.5, 1.8, 0.4),
    new THREE.MeshBasicMaterial({ color: 0x00aa22 })
  );
  monitor.position.set(2, 2.5, -8);
  scene.add(monitor);

  // Pistol
  const pistol = new THREE.Mesh(
    new THREE.BoxGeometry(0.8, 0.3, 2),
    new THREE.MeshBasicMaterial({ color: 0x333333 })
  );
  pistol.position.set(-1, 0.6, -8);
  pistol.visible = false;
  scene.add(pistol);
}
createOffice();

// =============== ENTITIES (Children / Monsters) ===============
function spawnEntity() {
  const isMonster = Math.random() < (shift * 0.1);
  const geo = isMonster ? new THREE.DodecahedronGeometry(0.8, 0) : new THREE.CylinderGeometry(0.5, 0.5, 1.6, 8);
  const color = isMonster ? 0xff0040 : 0x00aa22;
  const mat = new THREE.MeshBasicMaterial({ color });
  const entity = new THREE.Mesh(geo, mat);
  entity.position.set(Math.random()*10 - 5, 0.8, Math.random()*8 + 8);
  entity.userData = { isMonster, room: Math.floor(Math.random()*18) };
  scene.add(entity);

  addChatMsg(`A ${isMonster ? 'distorted monster' : 'child'} says: Room ${entity.userData.room + 1}`);
}

setInterval(() => {
  if (gameState === 'shift') spawnEntity();
}, 8000);

// =============== INTERACTION ===============
function interact() {
  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
  const intersects = raycaster.intersectObjects(scene.children);

  for (let obj of intersects) {
    if (obj.object.userData && obj.object.userData.room) {
      const entity = obj.object;
      const room = entity.userData.room;
      if (rooms[room] < 20 && !entity.userData.isMonster) {
        rooms[room]++;
        addChatMsg(`Child let into room ${room + 1}.`);
      } else {
        addChatMsg(`Invalid - pistol required.`);
      }
      scene.remove(entity);
    }
  }
}

// =============== PLAYER MOVEMENT ===============
const velocity = new THREE.Vector3();
const direction = new THREE.Vector3();

function updatePlayer(delta) {
  velocity.x *= 0.9;
  velocity.z *= 0.9;

  direction.z = Number(keys['w']) - Number(keys['s']);
  direction.x = Number(keys['d']) - Number(keys['a']);
  direction.normalize();

  if (direction.lengthSq() > 0) {
    const forward = new THREE.Vector3();
    camera.getWorldDirection(forward);
    forward.y = 0; forward.normalize();
    const right = forward.clone().cross(camera.up);

    velocity.add(forward.multiplyScalar(direction.z * 12 * delta));
    velocity.add(right.multiplyScalar(direction.x * 12 * delta));
  }

  controls.getObject().position.add(velocity);

  // Crouch
  if (keys['control']) {
    camera.position.y = 1.2;
    crouching = true;
  } else {
    camera.position.y = 1.8;
    crouching = false;
  }

  // E to interact
  if (keys['e']) {
    interact();
    keys['e'] = false;
  }
}

// =============== TIMER ===============
function updateTimer() {
  if (gameState !== 'shift') return;
  timeLeft--;
  document.getElementById('time').textContent = 
    `${Math.floor(timeLeft/60).toString().padStart(2,'0')}:${(timeLeft%60).toString().padStart(2,'0')}`;

  if (timeLeft <= 0) {
    gameState = 'end-shift';
    document.getElementById('end-shift').style.display = 'block';
    setTimeout(() => {
      gameState = 'driving';
      document.getElementById('end-shift').style.display = 'none';
      startDrivingPhase();
    }, 6000);
  }
}
setInterval(updateTimer, 1000);

// =============== DRIVING PHASE ===============
function startDrivingPhase() {
  addChatMsg("Driving home...");

  let t = 0;
  const drive = setInterval(() => {
    t += 0.1;
    scene.background = new THREE.Color(0x000011);
    scene.fog.color = new THREE.Color(0x000022);
    // Car view (simple)
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#111';
    ctx.fillRect(0, canvas.height/2 - 120, canvas.width, 240);
    if (Math.random() < 0.3) addChatMsg("A distorted monster is chasing the car!");

    if (t > 12) {
      clearInterval(drive);
      shift++;
      if (shift > 10) {
        addChatMsg("All shifts complete. The nightmare is over... or is it?");
        localStorage.removeItem('currentShift');
      } else {
        localStorage.setItem('currentShift', shift);
        timeLeft = 240;
        updateMissionText();
        gameState = 'shift';
      }
    }
  }, 100);
}

// =============== GAME LOOP ===============
let lastTime = performance.now();
function animate() {
  const now = performance.now();
  const delta = (now - lastTime) / 1000;
  lastTime = now;

  updatePlayer(delta);
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}
animate();

// =============== CHAT HELPER ===============
function addChatMsg(msg) {
  console.log(msg); // For now, expand with real UI later
}
</script>
</body>
</html>
