<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shift Horror - 10 Nights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; background:#000; font-family:'Courier New', monospace; color:#0f0; }
    canvas { display:block; }
    #ui {
      position:absolute; inset:0; pointer-events:none; color:#0f0; text-shadow:0 0 8px #0f0; font-size:1.4rem; padding:20px; z-index:10;
    }
    #phone {
      position:absolute; bottom:40px; left:50%; transform:translateX(-50%);
      width:360px; height:720px; background:#0a001a; border:6px solid #330066; border-radius:36px;
      padding:30px; box-shadow:0 0 60px #330066; display:none; pointer-events:all; overflow-y:auto; font-size:1.2rem; line-height:1.6; z-index:20;
    }
    #phone.show { display:block; }
    #time { position:absolute; top:20px; right:30px; font-size:3rem; text-shadow:0 0 12px #ff00aa; }
    #hud { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); font-size:2rem; text-shadow:0 0 10px #00ffff; }
    #shift-message {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      font-size:5rem; text-align:center; color:#ff0040; text-shadow:0 0 20px #ff0040; display:none; z-index:30;
    }
    #end-shift {
      position:absolute; inset:0; background:rgba(0,0,0,0.95); color:#ff0040; font-size:6rem; text-align:center; padding-top:40vh; display:none; z-index:30;
    }
  </style>
</head>
<body>

<div id="ui">
  <div id="time">04:00</div>
  <div id="hud"></div>
</div>

<div id="phone">
  <h2>Phone</h2>
  <div id="mission-text"></div>
</div>

<div id="shift-message"></div>
<div id="end-shift">YOUR SHIFT IS OVER<br>GO HOME</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/controls/PointerLockControls.min.js"></script>
<script>
// =============== SETUP ===============
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x110022);
scene.fog = new THREE.FogExp2(0x110022, 0.05);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: false });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(0.7);
document.body.appendChild(renderer.domElement);

const controls = new THREE.PointerLockControls(camera, renderer.domElement);
scene.add(controls.getObject());

camera.position.set(0, 1.8, 0);

// =============== LIGHTING (varied colors) ===============
scene.add(new THREE.AmbientLight(0x222244, 0.7));
scene.add(new THREE.PointLight(0x8800ff, 1.2, 40).position.set(5, 8, -5));
scene.add(new THREE.PointLight(0xff0040, 1.0, 30).position.set(-5, 5, 10));

// =============== OFFICE 3D ===============
function createOffice() {
  // Floor (deep purple)
  scene.add(new THREE.Mesh(
    new THREE.PlaneGeometry(60, 60),
    new THREE.MeshBasicMaterial({ color: 0x220033 })
  ).rotation.x = -Math.PI/2);

  // Walls (blue/purple)
  const wallMat = new THREE.MeshBasicMaterial({ color: 0x003366 });
  scene.add(new THREE.Mesh(new THREE.BoxGeometry(60, 12, 0.5), wallMat).translateZ(-30));
  scene.add(new THREE.Mesh(new THREE.BoxGeometry(60, 12, 0.5), wallMat).translateZ(30));
  scene.add(new THREE.Mesh(new THREE.BoxGeometry(0.5, 12, 60), wallMat).translateX(-30));
  scene.add(new THREE.Mesh(new THREE.BoxGeometry(0.5, 12, 60), wallMat).translateX(30));

  // Desk (orange wood)
  scene.add(new THREE.Mesh(
    new THREE.BoxGeometry(8, 2.5, 4),
    new THREE.MeshBasicMaterial({ color: 0x663300 })
  ).position.set(0, 1.25, -12));

  // Monitor (neon cyan)
  scene.add(new THREE.Mesh(
    new THREE.BoxGeometry(3, 2, 0.5),
    new THREE.MeshBasicMaterial({ color: 0x00ffcc })
  ).position.set(2.5, 3, -12));

  // Pistol under desk
  const pistol = new THREE.Mesh(
    new THREE.BoxGeometry(1, 0.4, 2.2),
    new THREE.MeshBasicMaterial({ color: 0x444466 })
  );
  pistol.position.set(-1.5, 0.8, -12);
  pistol.visible = false;
  scene.add(pistol);
}
createOffice();

// =============== ENTITIES ===============
function spawnEntity() {
  const isMonster = Math.random() < (shift * 0.12);
  const geo = isMonster ? new THREE.OctahedronGeometry(0.9) : new THREE.CylinderGeometry(0.5, 0.5, 1.8, 8);
  const color = isMonster ? 0xff0040 : 0x00aa44;
  const mat = new THREE.MeshBasicMaterial({ color });
  const entity = new THREE.Mesh(geo, mat);
  entity.position.set(Math.random()*12 - 6, 0.9, Math.random()*10 + 10);
  entity.userData = { isMonster, room: Math.floor(Math.random()*18) };
  scene.add(entity);

  addChatMsg(`A ${isMonster ? 'distorted monster' : 'child'} says: Room ${entity.userData.room + 1}`);
}

setInterval(() => {
  if (gameState === 'shift') spawnEntity();
}, 5000);

// =============== INTERACTION ===============
function interact() {
  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
  const intersects = raycaster.intersectObjects(scene.children);

  for (let obj of intersects) {
    if (obj.object.userData && obj.object.userData.room) {
      const entity = obj.object;
      const room = entity.userData.room;
      if (rooms[room] < 20 && !entity.userData.isMonster) {
        rooms[room]++;
        addChatMsg(`Child let into room ${room + 1}.`);
      } else {
        addChatMsg(`Invalid - pistol required.`);
      }
      scene.remove(entity);
    }
  }
}

// =============== PLAYER MOVEMENT ===============
const velocity = new THREE.Vector3();
const direction = new THREE.Vector3();

function updatePlayer(delta) {
  velocity.x *= 0.9;
  velocity.z *= 0.9;

  direction.z = Number(keys['w']) - Number(keys['s']);
  direction.x = Number(keys['d']) - Number(keys['a']);
  direction.normalize();

  if (direction.lengthSq() > 0) {
    const forward = new THREE.Vector3();
    camera.getWorldDirection(forward);
    forward.y = 0; forward.normalize();
    const right = forward.clone().cross(camera.up);

    velocity.add(forward.multiplyScalar(direction.z * 14 * delta));
    velocity.add(right.multiplyScalar(direction.x * 14 * delta));
  }

  controls.getObject().position.add(velocity);

  // Crouch
  if (keys['control']) {
    camera.position.y = 1.2;
  } else {
    camera.position.y = 1.8;
  }

  // E to interact
  if (keys['e']) {
    interact();
    keys['e'] = false;
  }
}

// =============== TIMER ===============
function updateTimer() {
  if (gameState !== 'shift') return;
  timeLeft--;
  document.getElementById('time').textContent = 
    `${Math.floor(timeLeft/60).toString().padStart(2,'0')}:${(timeLeft%60).toString().padStart(2,'0')}`;

  if (timeLeft <= 0) {
    gameState = 'end-shift';
    document.getElementById('end-shift').style.display = 'block';
    setTimeout(() => {
      gameState = 'driving';
      document.getElementById('end-shift').style.display = 'none';
      startDrivingPhase();
    }, 6000);
  }
}
setInterval(updateTimer, 1000);

// =============== DRIVING PHASE ===============
function startDrivingPhase() {
  addChatMsg("Driving home...");

  let t = 0;
  const drive = setInterval(() => {
    t += 0.1;
    scene.background = new THREE.Color(0x000022);
    scene.fog.color = new THREE.Color(0x000044);

    // Simple car road
    const road = new THREE.Mesh(
      new THREE.PlaneGeometry(20, 1000),
      new THREE.MeshBasicMaterial({ color: 0x111111 })
    );
    road.rotation.x = -Math.PI/2;
    road.position.z = -t*10;
    scene.add(road);

    if (Math.random() < 0.4) {
      addChatMsg("A distorted monster is chasing the car!");
    }

    if (t > 12) {
      clearInterval(drive);
      shift++;
      if (shift > 10) {
        addChatMsg("All shifts complete. The nightmare is over... or is it?");
        localStorage.removeItem('currentShift');
      } else {
        localStorage.setItem('currentShift', shift);
        timeLeft = 240;
        updateMissionText();
        gameState = 'shift';
      }
    }
  }, 100);
}

// =============== GAME LOOP ===============
let lastTime = performance.now();
function animate() {
  const now = performance.now();
  const delta = (now - lastTime) / 1000;
  lastTime = now;

  updatePlayer(delta);
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}
animate();

// =============== CHAT HELPER ===============
function addChatMsg(msg) {
  console.log(msg);
}
</script>
</body>
</html>
