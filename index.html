<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Horus Heresy – Legion Survival</title>
<style>
    body {
        margin:0;
        background:#000;
        color:#eee;
        font-family:Arial, sans-serif;
        overflow:hidden;
    }
    #ui {
        position:absolute;
        top:10px;
        left:10px;
        background:rgba(0,0,0,0.85);
        padding:15px;
        border:1px solid #444;
        z-index:10;
    }
    canvas {
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        cursor: crosshair;
    }
    button, select {
        margin-top:6px;
        padding:8px 12px;
        font-size:14px;
        background:#222;
        color:#eee;
        border:1px solid #555;
        border-radius:4px;
    }
</style>
</head>
<body>

<div id="ui">
    <select id="legionSelect">
        <option value="">Select Legion</option>
        <option>Ultramarines</option>
        <option>Blood Angels</option>
        <option>Imperial Fists</option>
        <option>Iron Warriors</option>
        <option>Night Lords</option>
    </select><br>
    <button onclick="startGame()">Deploy</button>
    <p style="font-size:12px;opacity:.7">Click soldier → WASD to move</p>
</div>

<!-- INTERNAL LOW RES, DISPLAY LARGE -->
<canvas id="canvas" width="350" height="225" style="width:1400px;height:900px"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
ctx.imageSmoothingEnabled = false;

let zoom = 1;
let cameraX = 700;
let cameraY = 450;

let playerUnits = [];
let selectedUnitIndex = null;
let enemies = [];
let buttonActivated = false;

const keys = { w:false, a:false, s:false, d:false };

const LEGION_COLORS = {
    Ultramarines:"#1976d2",
    Blood Angels:"#c62828",
    Imperial Fists:"#fdd835",
    Iron Warriors:"#777777",
    Night Lords:"#0d47a1"
};

window.addEventListener("keydown", e => {
    const k = e.key.toLowerCase();
    if (k in keys) keys[k] = true;
    if (e.key === "Escape") selectedUnitIndex = null;
});
window.addEventListener("keyup", e => {
    const k = e.key.toLowerCase();
    if (k in keys) keys[k] = false;
});

function startGame() {
    document.getElementById("ui").style.display = "none";

    playerUnits = [];
    for (let i=0;i<11;i++) {
        playerUnits.push({
            x:700+(i-5)*18,
            y:450+Math.floor(i/4)*16,
            hp:100,
            isLeader:i===5
        });
    }

    spawnEnemies();
    requestAnimationFrame(gameLoop);
}

function drawUnit(u, selected=false) {
    const x = Math.round(u.x);
    const y = Math.round(u.y);
    const s = u.isLeader ? 6 : 4;

    ctx.fillStyle = "#ccc";
    ctx.fillRect(x-s,y-s,s*2,s*2);

    if (selected) {
        ctx.strokeStyle="#ffff00";
        ctx.strokeRect(x-s-2,y-s-2,s*2+4,s*2+4);
    }
}

function drawEnemy(e) {
    ctx.fillStyle="#800";
    ctx.fillRect(Math.round(e.x-3),Math.round(e.y-3),6,6);
}

function keyboardMove() {
    if (selectedUnitIndex === null) return;
    const u = playerUnits[selectedUnitIndex];
    if (!u || u.hp<=0) return;

    let dx=0,dy=0;
    if (keys.w) dy--;
    if (keys.s) dy++;
    if (keys.a) dx--;
    if (keys.d) dx++;

    if (dx===0 && dy===0) return;

    const len = Math.hypot(dx,dy);
    dx/=len; dy/=len;

    const speed = u.isLeader ? 1.6 : 1.2;
    u.x += dx*speed;
    u.y += dy*speed;

    if (u.isLeader) {
        playerUnits.forEach(o=>{
            if(o!==u){
                o.x += dx*speed*0.8;
                o.y += dy*speed*0.8;
            }
        });
    }
}

function enemyAI() {
    enemies.forEach(e=>{
        let target=null,min=9999;
        playerUnits.forEach(p=>{
            const d=Math.hypot(p.x-e.x,p.y-e.y);
            if(d<min){min=d;target=p;}
        });
        if(!target) return;
        if(min<10) target.hp-=0.3;
        else {
            e.x+=(target.x-e.x)*0.005;
            e.y+=(target.y-e.y)*0.005;
        }
    });
}

function spawnEnemies() {
    setInterval(()=>{
        for(let i=0;i<5;i++){
            enemies.push({
                x:Math.random()*1400,
                y:cameraY-300,
                hp:60
            });
        }
    },6000);
}

canvas.addEventListener("click",e=>{
    const rect=canvas.getBoundingClientRect();
    const mx=(e.clientX-rect.left)/4;
    const my=(e.clientY-rect.top)/4;
    const wx=cameraX+(mx-canvas.width/2)/zoom;
    const wy=cameraY+(my-canvas.height/2)/zoom;

    selectedUnitIndex=null;
    playerUnits.forEach((u,i)=>{
        if(Math.hypot(wx-u.x,wy-u.y)<8)
            selectedUnitIndex=i;
    });
});

function gameLoop() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.save();
    ctx.translate(
        Math.round(canvas.width/2),
        Math.round(canvas.height/2)
    );
    ctx.scale(zoom,zoom);
    ctx.translate(
        Math.round(-cameraX),
        Math.round(-cameraY)
    );

    ctx.fillStyle="#2a3d1a";
    ctx.fillRect(-2000,-2000,4000,4000);

    enemies.forEach(drawEnemy);
    playerUnits.forEach((u,i)=>drawUnit(u,i===selectedUnitIndex));

    ctx.restore();

    keyboardMove();
    enemyAI();

    const focus =
        selectedUnitIndex!==null
        ? playerUnits[selectedUnitIndex]
        : playerUnits.find(u=>u.isLeader);

    if(focus){
        cameraX+=(focus.x-cameraX)*0.1;
        cameraY+=(focus.y-cameraY)*0.1;
    }

    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
