<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Legion Game</title>
<style>
 html,body{margin:0;overflow:hidden;background:#000}
 canvas{image-rendering:pixelated}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
const c = document.getElementById("c");
const ctx = c.getContext("2d");
c.width = innerWidth;
c.height = innerHeight;

// ================== CAMERA ==================
let camX=0, camY=0;

// ================== IMAGE ==================
const marineImg = new Image();
marineImg.src = "marine.png";
const legionSprites = {};

// ================== UTIL ==================
function hexToRgb(h){
 const n=parseInt(h.slice(1),16);
 return{r:(n>>16)&255,g:(n>>8)&255,b:n&255};
}

function tintSprite(img,color){
 const t=document.createElement("canvas");
 t.width=img.width; t.height=img.height;
 const g=t.getContext("2d");
 g.drawImage(img,0,0);
 const d=g.getImageData(0,0,t.width,t.height);
 const rgb=hexToRgb(color);
 for(let i=0;i<d.data.length;i+=4){
  const r=d.data[i],g0=d.data[i+1],b=d.data[i+2];
  if(b>r+20 && b>g0+20){
   d.data[i]=rgb.r;
   d.data[i+1]=rgb.g;
   d.data[i+2]=rgb.b;
  }
 }
 g.putImageData(d,0,0);
 return t;
}

function buildLegionSprites(color){
 legionSprites.normal = tintSprite(marineImg,color);
 legionSprites.leader = tintSprite(marineImg,"#ffeb3b");
}

// ================== WORLD ==================
const TILE=64;
function drawGround(){
 for(let x=-10;x<20;x++){
  for(let y=-10;y<20;y++){
   const wx=Math.floor((camX+x*TILE)/TILE);
   const wy=Math.floor((camY+y*TILE)/TILE);
   const px=wx*TILE-camX;
   const py=wy*TILE-camY;

   ctx.fillStyle="#2d6a2d";
   ctx.fillRect(px,py,TILE,TILE);

   if((wx+wy)%9===0){
    ctx.fillStyle="#1e4f1e";
    ctx.fillRect(px+20,py+20,24,24);
   }
   if((wx*wy)%17===0){
    ctx.fillStyle="#444";
    ctx.fillRect(px+10,py+30,40,20);
   }
   if((wx+wy)%23===0){
    ctx.fillStyle="#1e90ff";
    ctx.fillRect(px,py+40,TILE,24);
   }
  }
 }
}

// ================== UNITS ==================
const units=[];
let playerColor="#ff0000";

function spawnSquad(){
 units.length=0;
 for(let i=0;i<6;i++){
  units.push({
   x:200+i*18,y:200,
   leader:i===0,
   hp:100,
   vx:0,vy:0
  });
 }
}

function drawMarine(u){
 const img=u.leader?legionSprites.leader:legionSprites.normal;
 ctx.drawImage(img,u.x-camX-8,u.y-camY-10,16,20);
}

// ================== INPUT ==================
const keys={};
addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

addEventListener("click",e=>{
 const mx=e.clientX+camX,my=e.clientY+camY;
 units.forEach(u=>u.leader=false);
 let closest=null,d=9999;
 units.forEach(u=>{
  const dist=Math.hypot(u.x-mx,u.y-my);
  if(dist<d){d=dist;closest=u;}
 });
 if(closest)closest.leader=true;
});

// ================== BULLETS ==================
const bullets=[];
function shoot(x,y,dx,dy){
 bullets.push({x,y,dx,dy,life:80});
}

// ================== ENEMIES ==================
const enemies=[];
function spawnEnemy(){
 enemies.push({
  x:camX+Math.random()*c.width,
  y:camY+Math.random()*c.height,
  hp:50
 });
}

// ================== BUTTON ==================
const button={x:2200,y:1800,pressed:false};

function drawButton(){
 if(Math.hypot(button.x-camX,button.y-camY)>800)return;
 ctx.fillStyle="#555";
 ctx.fillRect(button.x-camX-20,button.y-camY-20,40,40);
 if(button.pressed){
  ctx.strokeStyle="#00f";
  ctx.lineWidth=4;
  ctx.beginPath();
  ctx.moveTo(button.x-camX,button.y-camY);
  ctx.lineTo(button.x-camX,button.y-camY-800);
  ctx.stroke();
 }
}

// ================== LOOP ==================
function update(){
 const leader=units.find(u=>u.leader);
 if(leader){
  if(keys.w)leader.y-=3;
  if(keys.s)leader.y+=3;
  if(keys.a)leader.x-=3;
  if(keys.d)leader.x+=3;
  camX=leader.x-c.width/2;
  camY=leader.y-c.height/2;
 }

 units.forEach(u=>{
  if(!u.leader){
   u.x+=(leader.x-u.x)*0.05;
   u.y+=(leader.y-u.y)*0.05;
  }
 });

 bullets.forEach(b=>{
  b.x+=b.dx;b.y+=b.dy;b.life--;
 });
 for(let i=bullets.length-1;i>=0;i--){
  if(bullets[i].life<=0)bullets.splice(i,1);
 }

 enemies.forEach(e=>{
  e.x+=(leader.x-e.x)*0.005;
  e.y+=(leader.y-e.y)*0.005;
 });

 if(Math.random()<0.02)spawnEnemy();

 if(!button.pressed && Math.hypot(leader.x-button.x,leader.y-button.y)<40){
  button.pressed=true;
 }
}

function draw(){
 ctx.clearRect(0,0,c.width,c.height);
 drawGround();

 enemies.forEach(e=>{
  ctx.fillStyle="purple";
  ctx.fillRect(e.x-camX-6,e.y-camY-6,12,12);
 });

 bullets.forEach(b=>{
  ctx.fillStyle="#ff0";
  ctx.fillRect(b.x-camX,b.y-camY,4,2);
 });

 units.forEach(drawMarine);
 drawButton();

 // TEAM HP
 const hp=units.reduce((a,b)=>a+b.hp,0)/(units.length*100);
 ctx.fillStyle="#000";
 ctx.fillRect(20,20,200,12);
 ctx.fillStyle="#0f0";
 ctx.fillRect(20,20,200*hp,12);
}

function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}

// ================== START ==================
marineImg.onload=()=>{
 buildLegionSprites(playerColor);
 spawnSquad();
 loop();
};
</script>
</body>
</html>
