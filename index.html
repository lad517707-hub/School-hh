<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Legion March</title>
<style>
body{margin:0;overflow:hidden;background:black}
canvas{
 image-rendering:pixelated;
 image-rendering:crisp-edges;
}
#ui{
 position:absolute;top:10px;left:10px;
 background:rgba(0,0,0,.8);
 color:#fff;padding:10px;
 font-family:Arial;border:1px solid #444;
 z-index:10
}
#end{
 position:absolute;inset:0;
 display:none;align-items:center;
 justify-content:center;flex-direction:column;
 background:rgba(0,0,40,.9);
 color:#0ff;font-size:28px;
}
</style>
</head>
<body>

<div id="ui">
<select id="legion">
<option value="">— Select Legion —</option>
<option value="ultra">Ultramarines</option>
<option value="blood">Blood Angels</option>
<option value="death">Death Guard</option>
<option value="night">Night Lords</option>
<option value="alpha">Alpha Legion</option>
</select>
<button onclick="start()">Deploy</button>
</div>

<div id="end">
<h1>VICTORY</h1>
<p>Orbital beam fired.</p>
<button onclick="location.reload()">Restart</button>
</div>

<canvas id="c" width="420" height="240"
style="width:1680px;height:960px"></canvas>

<script>
const c = document.getElementById("c");
const x = c.getContext("2d");
x.imageSmoothingEnabled = false;

let camX=0, camY=0;
let leader, units=[], enemies=[], bullets=[];
let chunks = {};
let win=false;

const keys={w:0,a:0,s:0,d:0};
onkeydown=e=>keys[e.key]=1;
onkeyup=e=>keys[e.key]=0;

const legionColors={
 ultra:"#2244cc", blood:"#8b0000",
 death:"#6b8f3f", night:"#1b1b3a",
 alpha:"#2aa6a6"
};

const machine = { x:0, y:-6000, active:false };

function start(){
 const l=document.getElementById("legion").value;
 if(!l) return;
 document.getElementById("ui").style.display="none";

 units=[];
 for(let i=0;i<9;i++){
  const u={
   x:(i%3)*12-12,
   y:Math.floor(i/3)*12,
   offX:(i%3)*12-12,
   offY:Math.floor(i/3)*12,
   leader:i===4,
   color:legionColors[l]
  };
  units.push(u);
  if(u.leader) leader=u;
 }
 camX=leader.x;
 camY=leader.y;
 loop();
}

/* ========= WORLD CHUNKS ========= */

const CHUNK=400;

function getChunk(cx,cy){
 const k=cx+","+cy;
 if(chunks[k]) return;
 const data={
  water:Math.random()<0.3,
  ruins:Math.random()<0.4,
  trees:Math.random()<0.6
 };
 chunks[k]=data;
}

function ensureChunks(){
 const cx=Math.floor(camX/CHUNK);
 const cy=Math.floor(camY/CHUNK);
 for(let dx=-2;dx<=2;dx++)
  for(let dy=-2;dy<=2;dy++)
   getChunk(cx+dx,cy+dy);
}

/* ========= UPDATE ========= */

function update(){
 let dx=0,dy=0;
 if(keys.w)dy--;
 if(keys.s)dy++;
 if(keys.a)dx--;
 if(keys.d)dx++;
 if(dx||dy){
  const l=Math.hypot(dx,dy);
  dx/=l; dy/=l;
  leader.x+=dx*2.4;
  leader.y+=dy*2.4;
 }

 units.forEach(u=>{
  if(!u.leader){
   u.x+=(leader.x+u.offX-u.x)*0.15;
   u.y+=(leader.y+u.offY-u.y)*0.15;
  }
 });

 // activate machine
 if(!win && Math.hypot(leader.x-machine.x,leader.y-machine.y)<30){
  machine.active=true;
  win=true;
  document.getElementById("end").style.display="flex";
 }

 camX+=(leader.x-camX)*0.1;
 camY+=(leader.y-camY)*0.1;

 ensureChunks();
}

/* ========= DRAW ========= */

function draw(){
 x.clearRect(0,0,c.width,c.height);
 x.save();
 x.translate(c.width/2,c.height/2);
 x.translate(-camX,-camY);

 // VOID FOG
 const fade=Math.min(1,Math.abs(camY)/5000);
 x.fillStyle=`rgb(${20*(1-fade)},${30*(1-fade)},${15*(1-fade)})`;

 // DRAW CHUNKS
 for(const k in chunks){
  const [cx,cy]=k.split(",").map(Number);
  const px=cx*CHUNK, py=cy*CHUNK;
  const d=chunks[k];

  x.fillRect(px,py,CHUNK,CHUNK);

  if(d.water){
   x.fillStyle="#1e4a7a";
   x.fillRect(px+80,py+140,240,60);
   x.fillStyle=`rgb(${20*(1-fade)},${30*(1-fade)},${15*(1-fade)})`;
  }

  if(d.ruins){
   x.fillStyle="#4a3728";
   for(let i=0;i<3;i++)
    x.fillRect(px+50+i*80,py+200,40,30);
   x.fillStyle=`rgb(${20*(1-fade)},${30*(1-fade)},${15*(1-fade)})`;
  }

  if(d.trees){
   x.fillStyle="#1f7a3a";
   for(let i=0;i<6;i++)
    x.fillRect(px+Math.random()*CHUNK,py+Math.random()*CHUNK,4,8);
   x.fillStyle=`rgb(${20*(1-fade)},${30*(1-fade)},${15*(1-fade)})`;
  }
 }

 // MACHINE
 x.fillStyle="#444";
 x.fillRect(machine.x-20,machine.y-20,40,40);
 x.fillStyle=machine.active?"#0ff":"#800";
 x.beginPath();
 x.arc(machine.x,machine.y,10,0,Math.PI*2);
 x.fill();

 if(machine.active){
  x.strokeStyle="#0ff";
  x.lineWidth=16;
  x.beginPath();
  x.moveTo(machine.x,machine.y);
  x.lineTo(machine.x,machine.y-2000);
  x.stroke();
 }

 // UNITS
 units.forEach(u=>{
  x.fillStyle=u.leader?"#ff0":u.color;
  x.fillRect(u.x-4,u.y-4,8,8);
 });

 x.restore();
}

/* ========= LOOP ========= */

function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
</script>
</body>
</html>
