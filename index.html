<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Horus Heresy â€“ Legion Survival</title>
<style>
    body { margin:0; padding:0; background:#000; color:#eee; font-family:Arial, sans-serif; overflow:hidden; }
    #ui { position:absolute; top:15px; left:15px; background:rgba(10,10,30,0.85); padding:20px; border:1px solid #444; border-radius:10px; z-index:10; max-width:340px; }
    #canvas { display:block; cursor:crosshair; image-rendering:pixelated; }
    button, select { padding:10px 16px; margin:8px 6px 8px 0; font-size:15px; background:#1a1a3a; color:#eee; border:1px solid #555; border-radius:6px; cursor:pointer; }
    button:hover { background:#2a2a5a; }
    #story { position:absolute; inset:0; background:rgba(0,0,20,0.92); z-index:20; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:50px; text-align:center; font-size:19px; line-height:1.6; }
    #story button { font-size:22px; padding:15px 40px; margin-top:40px; }
    #objective { position:absolute; bottom:20px; left:20px; background:rgba(0,0,0,0.7); padding:12px 20px; border-radius:8px; font-size:16px; max-width:600px; z-index:5; display:none; }
    #endScreen { position:absolute; inset:0; background:rgba(0,0,20,0.92); z-index:20; display:none; flex-direction:column; justify-content:center; align-items:center; padding:50px; text-align:center; font-size:28px; line-height:1.6; }
</style>
</head>
<body>

<div id="story">
    <h1>Abandoned Outpost â€“ Forgotten World</h1>
    <p>Your squad awakens in the ruins of an ancient settlement â€” crumbling stone walls, wooden shacks, a broken bridge over a sluggish river.<br>
    Warp-tainted creatures prowl the shadows. The path ahead is long and treacherous.<br><br>
    Lead your 10 battle-brothers and yourself to the distant machine. Activate the red button to call for orbital support.<br>
    The ground behind you crumbles as you advance â€” no turning back.</p>
    <button onclick="document.getElementById('story').style.display='none'">Begin Mission</button>
</div>

<div id="ui">
    <label><strong>Choose your Legion:</strong></label><br>
    <select id="legionSelect">
        <option value="">â€” Select Legion â€”</option>
        <option value="Dark Angels">I â€“ Dark Angels</option>
        <option value="Emperor's Children">III â€“ Emperor's Children</option>
        <option value="Iron Warriors">IV â€“ Iron Warriors</option>
        <option value="White Scars">V â€“ White Scars</option>
        <option value="Space Wolves">VI â€“ Space Wolves</option>
        <option value="Imperial Fists">VII â€“ Imperial Fists</option>
        <option value="Night Lords">VIII â€“ Night Lords</option>
        <option value="Blood Angels">IX â€“ Blood Angels</option>
        <option value="Iron Hands">X â€“ Iron Hands</option>
        <option value="World Eaters">XII â€“ World Eaters</option>
        <option value="Ultramarines">XIII â€“ Ultramarines</option>
        <option value="Death Guard">XIV â€“ Death Guard</option>
        <option value="Thousand Sons">XV â€“ Thousand Sons</option>
        <option value="Sons of Horus">XVI â€“ Sons of Horus</option>
        <option value="Word Bearers">XVII â€“ Word Bearers</option>
        <option value="Salamanders">XVIII â€“ Salamanders</option>
        <option value="Raven Guard">XIX â€“ Raven Guard</option>
        <option value="Alpha Legion">XX â€“ Alpha Legion</option>
    </select><br>
    <button onclick="startCampaign()">Deploy</button>
</div>

<canvas id="canvas" width="1400" height="900"></canvas>

<div id="objective">Select a marine (click on him), then click destination to move.<br>Click your leader (YOU) to make squad follow in formation.<br>Use mouse wheel to zoom in/out for details. Advance forward â€” the path behind fades.</div>

<div id="endScreen">
    <h1>Victory â€“ Beam Activated</h1>
    <p>The crimson button glows. A blinding blue beam lances into the heavens.<br>Reinforcements inbound. The outpost is secured... for the Emperor (or the Warmaster).</p>
    <button onclick="location.reload()">New Campaign</button>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let playerColor = null;
let playerLegionName = "";
let playerUnits = [];
let selectedUnitIndex = null;
let enemies = [];
let machinePos = {x: 700, y: -3000};
let buttonActivated = false;
let zoom = 1;
let cameraX = 700;
let cameraY = 800;
let worldObjects = [];

const LEGION_DETAILS = {
    "Dark Angels":       {main:"#2e7d32", accent:"#1b5e20", symbol:"sword"},
    "Emperor's Children":{main:"#7b1fa2", accent:"#d500f9", symbol:"eagle"},
    "Iron Warriors":     {main:"#616161", accent:"#424242", symbol:"skull"},
    "White Scars":       {main:"#e0e0e0", accent:"#ffffff", symbol:"lightning"},
    "Space Wolves":      {main:"#90caf9", accent:"#bbdefb", symbol:"wolf"},
    "Imperial Fists":    {main:"#ffeb3b", accent:"#fdd835", symbol:"fist"},
    "Night Lords":       {main:"#0d47a1", accent:"#1565c0", symbol:"bat"},
    "Blood Angels":      {main:"#c62828", accent:"#b71c1c", symbol:"drop"},
    "Iron Hands":        {main:"#212121", accent:"#424242", symbol:"hand"},
    "World Eaters":      {main:"#b71c1c", accent:"#d32f2f", symbol:"axe"},
    "Ultramarines":      {main:"#1976d2", accent:"#1565c0", symbol:"U"},
    "Death Guard":       {main:"#558b2f", accent:"#33691e", symbol:"fly"},
    "Thousand Sons":     {main:"#283593", accent:"#4527a0", symbol:"eye"},
    "Sons of Horus":     {main:"#2e7d32", accent:"#1b5e20", symbol:"eye"},
    "Word Bearers":      {main:"#880e4f", accent:"#ad1457", symbol:"book"},
    "Salamanders":       {main:"#1b5e20", accent:"#2e7d32", symbol:"flame"},
    "Raven Guard":       {main:"#263238", accent:"#37474f", symbol:"raven"},
    "Alpha Legion":      {main:"#00695c", accent:"#004d40", symbol:"hydra"}
};

function generateMap() {
    worldObjects = [];
    let pathY = 900;
    while (pathY > machinePos.y - 200) {
        worldObjects.push({type:'path', x:500 + Math.sin(pathY/200)*200, y:pathY, w:400, h:100});
        pathY -= 100;
    }
    for (let i = 0; i < 8; i++) {
        let ry = Math.random()*6000 - 3000;
        worldObjects.push({type:'river', x:200 + Math.random()*800, y:ry, w:1000, h:180});
        if (Math.random() > 0.5) worldObjects.push({type:'bridge', x:600 + Math.random()*200, y:ry + 50});
        if (Math.random() > 0.7) worldObjects.push({type:'boat', x:680 + Math.random()*200, y:ry + 80});
    }
    for (let i = 0; i < 80; i++) {
        let objY = Math.random()*6000 - 3000;
        let objX = Math.random()*1400;
        let r = Math.random();
        if (r < 0.2) worldObjects.push({type:'ruin', x:objX, y:objY, w:100+Math.random()*100, h:80+Math.random()*80, col:"#4a3728"});
        else if (r < 0.3) worldObjects.push({type:'log', x:objX, y:objY});
        else if (r < 0.4) worldObjects.push({type:'stoneWall', x:objX, y:objY, len:200+Math.random()*200});
        else if (r < 0.6) worldObjects.push({type:'flower', x:objX, y:objY, count:4+Math.floor(Math.random()*6)});
        else if (r < 0.8) worldObjects.push({type:'tree', x:objX, y:objY, size:30+Math.random()*40});
        else worldObjects.push({type:'rock', x:objX, y:objY, size:20+Math.random()*30});
    }
}

function startCampaign() {
    const sel = document.getElementById('legionSelect').value;
    if (!sel) return alert("Select your Legion first!");
    playerLegionName = sel;
    playerColor = LEGION_DETAILS[sel]?.main || "#888888";
    document.getElementById('ui').style.display = 'none';
    document.getElementById('objective').style.display = 'block';

    generateMap();

    playerUnits = [];
    for(let i = 0; i < 11; i++){
        playerUnits.push({
            x: 620 + (i-5)*18,
            y: 780 + Math.random()*20 -10,
            destX: null, destY: null,
            hp: 100,
            isLeader: i === 5
        });
    }

    spawnEnemies();
    requestAnimationFrame(gameLoop);
}

function drawLegionnaire(x, y, details, size = 11, isLeader = false, zoomLevel) {
    const s = size * (isLeader ? 1.45 : 1);

    // Torso / base armor
    ctx.fillStyle = details.main;
    ctx.beginPath();
    ctx.ellipse(x, y, s*0.9, s*1.1, 0, 0, Math.PI*2);
    ctx.fill();

    // Helmet
    ctx.fillStyle = details.accent || details.main;
    ctx.beginPath();
    ctx.arc(x, y - s*0.65, s*0.55, 0, Math.PI*2);
    ctx.fill();

    // Shoulder pads
    ctx.fillStyle = details.accent;
    ctx.beginPath();
    ctx.arc(x - s*0.9, y - s*0.35, s*0.65, 0, Math.PI*2);
    ctx.arc(x + s*0.9, y - s*0.35, s*0.65, 0, Math.PI*2);
    ctx.fill();

    // Legion symbol on chest
    if (zoomLevel > 1.4) {
        ctx.fillStyle = "#ffffffaa";
        ctx.font = `${s*1.1}px Arial`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        let sym = "âš”";
        switch(details.symbol) {
            case "sword":   sym = "â€ "; break;
            case "eagle":   sym = "ðŸ¦…"; break;
            case "skull":   sym = "â˜ "; break;
            case "lightning": sym = "âš¡"; break;
            case "wolf":    sym = "ðŸº"; break;
            case "fist":    sym = "âœŠ"; break;
            case "bat":     sym = "ðŸ¦‡"; break;
            case "drop":    sym = "ðŸ’§"; break;
            case "hand":    sym = "ðŸ¤–"; break;
            case "axe":     sym = "ðŸª“"; break;
            case "U":       sym = "U"; break;
            case "fly":     sym = "ðŸª°"; break;
            case "eye":     sym = "ðŸ‘"; break;
            case "book":    sym = "ðŸ“–"; break;
            case "flame":   sym = "ðŸ”¥"; break;
            case "raven":   sym = "ðŸ¦…"; break;
            case "hydra":   sym = "ðŸ‰"; break;
        }
        ctx.fillText(sym, x, y);
    }

    if (isLeader) {
        ctx.strokeStyle = "#ffff99";
        ctx.lineWidth = 4 / zoomLevel;
        ctx.beginPath();
        ctx.arc(x, y, s*1.35, 0, Math.PI*2);
        ctx.stroke();
    }
}

function drawUnits() {
    ctx.shadowColor = 'rgba(0,0,0,0.6)';
    ctx.shadowBlur = 8 / zoom;
    ctx.shadowOffsetX = 6 / zoom;
    ctx.shadowOffsetY = 6 / zoom;

    playerUnits.forEach((u, i) => {
        if (u.hp <= 0) return;
        const details = LEGION_DETAILS[playerLegionName] || {main: playerColor, accent: playerColor, symbol: "?"};
        drawLegionnaire(u.x, u.y, details, 11, u.isLeader, zoom);

        if (selectedUnitIndex === i) {
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 3 / zoom;
            ctx.beginPath();
            ctx.arc(u.x, u.y, u.isLeader ? 22 : 16, 0, Math.PI*2);
            ctx.stroke();
        }
    });

    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;
}

function drawWorld() {
    ctx.fillStyle = '#3a5c2f';
    ctx.fillRect(-1000, -4000, 3000, 6000);

    ctx.shadowColor = 'rgba(0,0,0,0.4)';
    ctx.shadowBlur = 5 / zoom;
    ctx.shadowOffsetX = 4 / zoom;
    ctx.shadowOffsetY = 4 / zoom;

    worldObjects.forEach(obj => {
        switch (obj.type) {
            case 'path':
                ctx.fillStyle = '#555555';
                ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
                break;
            case 'river':
                ctx.fillStyle = '#1e6fa5';
                ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
                ctx.fillStyle = '#2a8bc4';
                ctx.fillRect(obj.x + 20, obj.y + 20, obj.w - 40, obj.h - 40);
                break;
            case 'bridge':
                ctx.fillStyle = '#8b5a2b';
                ctx.fillRect(obj.x-80, obj.y-20, 160, 40);
                ctx.fillStyle = '#6d4c41';
                for(let i=-70;i<=70;i+=30) ctx.fillRect(obj.x+i, obj.y-30, 20, 60);
                break;
            case 'boat':
                ctx.fillStyle = '#6d4c41';
                ctx.beginPath();
                ctx.moveTo(obj.x-50,obj.y); ctx.lineTo(obj.x+50,obj.y); ctx.lineTo(obj.x+30,obj.y+40); ctx.lineTo(obj.x-30,obj.y+40);
                ctx.closePath(); ctx.fill();
                break;
            case 'ruin':
                ctx.fillStyle = obj.col;
                ctx.fillRect(obj.x,obj.y,obj.w,obj.h);
                ctx.fillStyle = '#333';
                ctx.fillRect(obj.x+10,obj.y+10,obj.w-20,obj.h-30);
                break;
            case 'log':
                for(let i=0;i<4;i++){
                    ctx.fillStyle = '#8b4513';
                    ctx.fillRect(obj.x + i*25, obj.y + Math.sin(i)*10, 60, 20);
                }
                break;
            case 'stoneWall':
                ctx.fillStyle = '#777';
                ctx.fillRect(obj.x, obj.y, 40, obj.len);
                ctx.fillStyle = '#666';
                for(let i=0;i<obj.len;i+=30) ctx.fillRect(obj.x+5, obj.y+i+10, 30, 10);
                break;
            case 'flower':
                for(let i=0;i<obj.count;i++){
                    ctx.fillStyle = Math.random()>0.5 ? '#ff69b4' : '#00ff7f';
                    ctx.beginPath();
                    ctx.arc(obj.x + (Math.random()-0.5)*80, obj.y + (Math.random()-0.5)*40, 6,0,Math.PI*2);
                    ctx.fill();
                }
                break;
            case 'tree':
                ctx.fillStyle = '#3b2f2f';
                ctx.fillRect(obj.x - obj.size/6, obj.y, obj.size/3, obj.size * 1.2);
                ctx.fillStyle = '#228B22';
                ctx.beginPath();
                ctx.arc(obj.x, obj.y - obj.size/2, obj.size/2, 0, Math.PI*2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(obj.x - obj.size/3, obj.y - obj.size/1.5, obj.size/3, 0, Math.PI*2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(obj.x + obj.size/3, obj.y - obj.size/1.5, obj.size/3, 0, Math.PI*2);
                ctx.fill();
                break;
            case 'rock':
                ctx.fillStyle = '#696969';
                ctx.beginPath();
                ctx.moveTo(obj.x, obj.y);
                ctx.lineTo(obj.x + obj.size/2, obj.y - obj.size);
                ctx.lineTo(obj.x + obj.size, obj.y);
                ctx.lineTo(obj.x + obj.size/2, obj.y + obj.size/2);
                ctx.closePath();
                ctx.fill();
                break;
        }
    });

    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;

    // Grass detail when zoomed in
    if (zoom > 1.2) {
        for (let i = 0; i < 800 * zoom; i++) {
            let gx = Math.random() * 2800 - 700;
            let gy = Math.random() * 6000 - 3000;
            ctx.strokeStyle = `rgba(0,${Math.random()*100 + 100},0,${Math.random()*0.5 + 0.3})`;
            ctx.lineWidth = 1 / zoom;
            ctx.beginPath();
            ctx.moveTo(gx, gy);
            ctx.lineTo(gx + (Math.random()-0.5)*5, gy - Math.random()*10 -5);
            ctx.stroke();
        }
    }

    // Machine
    ctx.fillStyle = '#555588';
    ctx.fillRect(machinePos.x-40, machinePos.y-40, 80, 80);
    ctx.fillStyle = buttonActivated ? '#00aaff' : '#880000';
    ctx.beginPath();
    ctx.arc(machinePos.x, machinePos.y, 22, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#ffffff';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText("MACHINE", machinePos.x, machinePos.y + 60);
}

function drawEnemies() {
    ctx.shadowColor = 'rgba(0,0,0,0.6)';
    ctx.shadowBlur = 8 / zoom;
    ctx.shadowOffsetX = 6 / zoom;
    ctx.shadowOffsetY = 6 / zoom;

    enemies.forEach(e => {
        if (e.hp <= 0) return;
        ctx.fillStyle = '#4a0000';
        ctx.beginPath();
        ctx.arc(e.x, e.y, 13, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = '#ff0000';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText("Warp Spawn", e.x, e.y-18);
    });

    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;
}

function drawFadeBehind() {
    let behindY = -Infinity;
    playerUnits.forEach(u => {
        if (u.hp > 0) behindY = Math.max(behindY, u.y);
    });
    if (behindY === -Infinity) return;

    const grad = ctx.createLinearGradient(0, behindY + 150, 0, behindY + 400);
    grad.addColorStop(0, 'rgba(0,0,0,0)');
    grad.addColorStop(1, 'rgba(0,0,0,1)');
    ctx.fillStyle = grad;
    ctx.fillRect(-1000, behindY + 150, 3000, 1000);
}

function moveUnits() {
    playerUnits.forEach(u => {
        if (u.hp <= 0 || !u.destX) return;
        const dx = u.destX - u.x;
        const dy = u.destY - u.y;
        const dist = Math.hypot(dx, dy);
        if (dist < 4) {
            u.destX = u.destY = null;
            return;
        }
        const speed = u.isLeader ? 2.4 : 2.1;
        u.x += dx / dist * speed;
        u.y += dy / dist * speed;
    });
}

function enemyAI() {
    enemies.forEach(e => {
        if (e.hp <= 0) return;
        let target = null, minD = Infinity;
        playerUnits.forEach(p => {
            if (p.hp > 0) {
                const d = Math.hypot(p.x - e.x, p.y - e.y);
                if (d < minD) { minD = d; target = p; }
            }
        });
        if (!target) return;

        const dx = target.x - e.x;
        const dy = target.y - e.y;
        const dist = Math.hypot(dx, dy);

        if (dist < 25) {
            target.hp -= 0.8;
        } else {
            e.x += dx / dist * 1.1;
            e.y += dy / dist * 1.1;
        }
    });
}

function playerCombat() {
    playerUnits.forEach(u => {
        if (u.hp <= 0) return;
        let closestE = null, minD = Infinity;
        enemies.forEach(e => {
            if (e.hp > 0) {
                const d = Math.hypot(e.x - u.x, e.y - u.y);
                if (d < 140 && d < minD) { minD = d; closestE = e; }
            }
        });
        if (closestE && minD < 140) {
            ctx.strokeStyle = '#ff8800';
            ctx.lineWidth = 3 / zoom;
            ctx.beginPath();
            ctx.moveTo(u.x, u.y);
            ctx.lineTo(closestE.x, closestE.y);
            ctx.stroke();
            closestE.hp -= 0.7;
        }
    });
}

function spawnEnemies() {
    setInterval(() => {
        if (buttonActivated) return;
        const num = Math.floor(Math.random()*6) + 5;
        const minPY = playerUnits.reduce((min,u)=> u.hp>0 ? Math.min(min,u.y) : min, Infinity);
        for(let i=0; i<num; i++){
            enemies.push({
                x: Math.random()*1400,
                y: minPY - 100 - Math.random()*300,
                hp: 60 + Math.random()*30
            });
        }
    }, 8000);
}

function checkActivation() {
    if (buttonActivated) return;
    if (playerUnits.some(u => u.hp > 0 && Math.hypot(u.x - machinePos.x, u.y - machinePos.y) < 60)) {
        buttonActivated = true;
        setTimeout(() => {
            document.getElementById('endScreen').style.display = 'flex';
        }, 1500);
    }
}

function gameLoop() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.scale(zoom, zoom);
    ctx.translate(-cameraX, -cameraY);

    drawWorld();
    drawUnits();
    drawEnemies();
    drawFadeBehind();

    ctx.restore();

    const leader = playerUnits.find(u => u.isLeader && u.hp > 0);
    if (leader) {
        cameraX += (leader.x - cameraX) * 0.1;
        cameraY += (leader.y - cameraY) * 0.1;
    }

    moveUnits();
    enemyAI();
    playerCombat();
    checkActivation();

    enemies = enemies.filter(e => e.hp > 0);
    playerUnits = playerUnits.filter(u => u.hp > 0);

    requestAnimationFrame(gameLoop);
}

canvas.addEventListener('click', e => {
    if (buttonActivated) return;
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    const worldX = cameraX + (mouseX - canvas.width / 2) / zoom;
    const worldY = cameraY + (mouseY - canvas.height / 2) / zoom;

    if (Math.hypot(worldX - machinePos.x, worldY - machinePos.y) < 30) {
        if (playerUnits.some(u => Math.hypot(u.x - machinePos.x, u.y - machinePos.y) < 70)) {
            buttonActivated = true;
        }
        return;
    }

    let clicked = null;
    playerUnits.forEach((u,i) => {
        if (u.hp > 0 && Math.hypot(worldX - u.x, worldY - u.y) < (u.isLeader ? 18 : 13)) {
            clicked = i;
        }
    });
    if (clicked !== null) {
        selectedUnitIndex = clicked;
        return;
    }

    if (selectedUnitIndex !== null) {
        const u = playerUnits[selectedUnitIndex];
        if (u.hp > 0) {
            u.destX = worldX;
            u.destY = worldY;
            if (u.isLeader) {
                playerUnits.forEach(other => {
                    if (other !== u && other.hp > 0) {
                        other.destX = worldX + (Math.random()-0.5)*60;
                        other.destY = worldY + (Math.random()-0.5)*60;
                    }
                });
            }
        }
        selectedUnitIndex = null;
    }
});

canvas.addEventListener('wheel', e => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    const mouseWorldX = cameraX + (mouseX - canvas.width / 2) / zoom;
    const mouseWorldY = cameraY + (mouseY - canvas.height / 2) / zoom;

    zoom = Math.max(0.5, Math.min(4, zoom - Math.sign(e.deltaY) * 0.2));

    cameraX = mouseWorldX - (mouseX - canvas.width / 2) / zoom;
    cameraY = mouseWorldY - (mouseY - canvas.height / 2) / zoom;
});

// Optional initial draw
drawWorld();
</script>
</body>
</html>
