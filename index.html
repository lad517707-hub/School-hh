<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Horus Heresy – Legion Survival</title>
<style>
    body { margin:0; padding:0; background:#000; color:#eee; font-family:Arial, sans-serif; overflow:hidden; }
    #ui {
        position: absolute; top:15px; left:15px; background:rgba(10,10,30,0.85);
        padding:20px; border:1px solid #444; border-radius:10px; z-index:10; max-width:340px;
    }
    #canvas { display:block; }
    button, select {
        padding:10px 16px; margin:8px 6px 8px 0; font-size:15px; background:#1a1a3a; color:#eee;
        border:1px solid #555; border-radius:6px; cursor:pointer;
    }
    button:hover { background:#2a2a5a; }
    #story {
        position:absolute; inset:0; background:rgba(0,0,20,0.92); z-index:20;
        display:flex; flex-direction:column; justify-content:center; align-items:center;
        padding:50px; text-align:center; font-size:19px; line-height:1.6;
    }
    #story button { font-size:22px; padding:15px 40px; margin-top:40px; }
    #objective {
        position:absolute; bottom:20px; left:20px; background:rgba(0,0,0,0.7);
        padding:12px 20px; border-radius:8px; font-size:16px; max-width:500px; z-index:5;
        display:none;
    }
    #endScreen {
        position:absolute; inset:0; background:rgba(0,0,20,0.92); z-index:20;
        display:none; flex-direction:column; justify-content:center; align-items:center;
        padding:50px; text-align:center; font-size:24px; line-height:1.6;
    }
</style>
</head>
<body>

<div id="story">
    <h1>The Horus Heresy – Abandoned Realm</h1>
    <p>In the ruins of a forgotten world, echoing the shattered spires of ancient Terra mixed with medieval fortresses,<br>
    your Legion squad awakens amidst chaos. Creatures of the warp swarm the shadows.<br><br>
    Lead your 10 soldiers and yourself to the ancient machine. Press the red button to activate the beam<br>
    and summon reinforcements – but survive the waves of horrors first!</p>
    <button onclick="document.getElementById('story').style.display='none'">Enter the Ruins</button>
</div>

<div id="ui">
    <label><strong>Choose your Legion:</strong></label><br>
    <select id="legionSelect">
        <option value="">— Select Your Legion —</option>
        <option value="Dark Angels">I – Dark Angels</option>
        <option value="Emperor's Children">III – Emperor's Children</option>
        <option value="Iron Warriors">IV – Iron Warriors</option>
        <option value="White Scars">V – White Scars</option>
        <option value="Space Wolves">VI – Space Wolves</option>
        <option value="Imperial Fists">VII – Imperial Fists</option>
        <option value="Night Lords">VIII – Night Lords</option>
        <option value="Blood Angels">IX – Blood Angels</option>
        <option value="Iron Hands">X – Iron Hands</option>
        <option value="World Eaters">XII – World Eaters</option>
        <option value="Ultramarines">XIII – Ultramarines</option>
        <option value="Death Guard">XIV – Death Guard</option>
        <option value="Thousand Sons">XV – Thousand Sons</option>
        <option value="Sons of Horus">XVI – Sons of Horus</option>
        <option value="Word Bearers">XVII – Word Bearers</option>
        <option value="Salamanders">XVIII – Salamanders</option>
        <option value="Raven Guard">XIX – Raven Guard</option>
        <option value="Alpha Legion">XX – Alpha Legion</option>
    </select><br>
    <button onclick="startCampaign()">Launch Mission</button>
</div>

<canvas id="canvas" width="1280" height="720"></canvas>

<div id="objective">Click a soldier to select, then click a spot to move them. Move the leader (YOU) to have the team follow. Survive waves and reach the machine to press the red button!</div>

<div id="endScreen">
    <h1>Mission Complete!</h1>
    <p>The blue beam pierces the sky, summoning aid. Your Legion prevails... for now.</p>
    <button onclick="location.reload()">Restart</button>
</div>

<script>
// ────────────────────────────────────────────────
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const legions = {
    "Dark Angels": "#2e7d32",
    "Emperor's Children": "#7b1fa2",
    "Iron Warriors": "#616161",
    "White Scars": "#e0e0e0",
    "Space Wolves": "#90caf9",
    "Imperial Fists": "#ffeb3b",
    "Night Lords": "#0d47a1",
    "Blood Angels": "#c62828",
    "Iron Hands": "#212121",
    "World Eaters": "#b71c1c",
    "Ultramarines": "#1976d2",
    "Death Guard": "#558b2f",
    "Thousand Sons": "#283593",
    "Sons of Horus": "#2e7d32",
    "Word Bearers": "#880e4f",
    "Salamanders": "#1b5e20",
    "Raven Guard": "#263238",
    "Alpha Legion": "#00695c"
};

let playerColor = null;
let playerUnits = []; // {x, y, destX, destY, hp, isLeader}
let selectedUnit = null;
let enemies = []; // {x, y, hp, type}
let wave = 0;
let machine = {x: 1200, y: 360, activated: false}; // right side
let beamActive = false;

function startCampaign() {
    const sel = document.getElementById('legionSelect').value;
    if (!sel) { alert("Choose your Legion first!"); return; }
    playerColor = legions[sel];
    document.getElementById('ui').style.display = 'none';
    document.getElementById('objective').style.display = 'block';

    // Spawn player squad left side
    playerUnits = [];
    for (let i = 0; i < 11; i++) { // 10 soldiers + leader
        playerUnits.push({
            x: 100 + Math.random() * 50,
            y: 200 + Math.random() * 300,
            destX: null,
            destY: null,
            hp: 100,
            isLeader: i === 0
        });
    }

    gameLoop();
    spawnWave();
}

function drawRuins() {
    // Dark ruined city background
    const grad = ctx.createLinearGradient(0,0,0,canvas.height);
    grad.addColorStop(0, "#333333");
    grad.addColorStop(1, "#111111");
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Ruined buildings (medieval NYC vibe: tall ruins, towers)
    ctx.fillStyle = "#444444";
    ctx.fillRect(150, 100, 80, 400); // ruined skyscraper
    ctx.fillRect(300, 200, 60, 300);
    ctx.fillRect(450, 50, 100, 450);
    ctx.fillRect(600, 150, 70, 350);
    ctx.fillRect(750, 100, 90, 400);
    ctx.fillRect(900, 250, 50, 250);
    ctx.fillRect(1050, 80, 110, 420);

    // Medieval elements: arches, stones
    ctx.strokeStyle = "#666666";
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.arc(200, 500, 40, Math.PI, 2*Math.PI); // arch
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(350, 500, 30, Math.PI, 2*Math.PI);
    ctx.stroke();

    // Ground cracks
    ctx.strokeStyle = "#222222";
    ctx.beginPath();
    ctx.moveTo(0,600); ctx.lineTo(1280,600);
    ctx.moveTo(200,620); ctx.lineTo(400,580);
    ctx.moveTo(600,640); ctx.lineTo(800,590);
    ctx.stroke();
}

function drawUnits() {
    playerUnits.forEach((u, i) => {
        if (u.hp <= 0) return;
        ctx.fillStyle = playerColor;
        ctx.beginPath();
        ctx.arc(u.x, u.y, u.isLeader ? 15 : 10, 0, Math.PI*2);
        ctx.fill();
        if (u.isLeader) {
            ctx.fillStyle = "#fff";
            ctx.font = "12px Arial";
            ctx.fillText("YOU", u.x - 10, u.y - 20);
        }
        if (selectedUnit === i) {
            ctx.strokeStyle = "#ffff00";
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    });
}

function drawEnemies() {
    enemies.forEach(e => {
        if (e.hp <= 0) return;
        ctx.fillStyle = "#ff0000";
        ctx.beginPath();
        ctx.arc(e.x, e.y, 12, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = "#fff";
        ctx.font = "10px Arial";
        ctx.fillText("Creature", e.x - 15, e.y - 15);
    });
}

function drawMachine() {
    ctx.fillStyle = "#888888";
    ctx.fillRect(machine.x - 30, machine.y - 30, 60, 60);
    ctx.fillStyle = "#ff0000";
    ctx.beginPath();
    ctx.arc(machine.x, machine.y, 15, 0, Math.PI*2);
    ctx.fill();
    if (beamActive) {
        ctx.strokeStyle = "#00ffff";
        ctx.lineWidth = 20;
        ctx.beginPath();
        ctx.moveTo(machine.x, machine.y);
        ctx.lineTo(machine.x, 0);
        ctx.stroke();
    }
}

function moveUnits() {
    playerUnits.forEach((u, i) => {
        if (u.hp <= 0 || !u.destX) return;
        const dx = u.destX - u.x;
        const dy = u.destY - u.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 5) {
            u.destX = null;
            u.destY = null;
            return;
        }
        const speed = 2;
        u.x += (dx / dist) * speed;
        u.y += (dy / dist) * speed;
    });
}

function enemyAI() {
    enemies.forEach(e => {
        if (e.hp <= 0) return;
        // Find nearest player unit
        let nearest = null;
        let minDist = Infinity;
        playerUnits.forEach(u => {
            if (u.hp > 0) {
                const d = Math.hypot(e.x - u.x, e.y - u.y);
                if (d < minDist) {
                    minDist = d;
                    nearest = u;
                }
            }
        });
        if (nearest) {
            const dx = nearest.x - e.x;
            const dy = nearest.y - e.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const speed = 1.5;
            e.x += (dx / dist) * speed;
            e.y += (dy / dist) * speed;

            // Attack if close
            if (dist < 20) {
                nearest.hp -= 1; // damage over time
            }
        }
    });
}

function combat() {
    playerUnits.forEach(u => {
        if (u.hp <= 0) return;
        // Find nearest enemy in range (100px)
        let nearestE = null;
        let minDist = Infinity;
        enemies.forEach(e => {
            if (e.hp > 0) {
                const d = Math.hypot(e.x - u.x, e.y - u.y);
                if (d < 100 && d < minDist) {
                    minDist = d;
                    nearestE = e;
                }
            }
        });
        if (nearestE) {
            // Shoot: draw laser, damage
            ctx.strokeStyle = "#00ff00";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(u.x, u.y);
            ctx.lineTo(nearestE.x, nearestE.y);
            ctx.stroke();
            nearestE.hp -= 0.5; // gradual damage
        }
    });
}

function spawnWave() {
    wave++;
    const num = wave * 3; // increasing
    for (let i = 0; i < num; i++) {
        enemies.push({
            x: 1280 - Math.random() * 200, // from right
            y: Math.random() * 720,
            hp: 50,
            type: "creature"
        });
    }
    setTimeout(spawnWave, 20000); // every 20s
}

function checkWin() {
    if (machine.activated) {
        beamActive = true;
        setTimeout(() => {
            document.getElementById('endScreen').style.display = 'flex';
        }, 2000);
    }
}

function gameLoop() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawRuins();
    drawMachine();
    drawUnits();
    drawEnemies();
    moveUnits();
    enemyAI();
    combat();
    checkWin();

    // Clean dead
    enemies = enemies.filter(e => e.hp > 0);
    playerUnits = playerUnits.filter(u => u.hp > 0);

    if (playerUnits.length === 0) {
        // Game over, but not implemented
    }

    requestAnimationFrame(gameLoop);
}

canvas.addEventListener('click', e => {
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;

    if (machine.activated) return;

    // Check if clicking machine button
    if (Math.hypot(clickX - machine.x, clickY - machine.y) < 20) {
        // Check if a unit is near
        const near = playerUnits.some(u => u.hp > 0 && Math.hypot(u.x - machine.x, u.y - machine.y) < 50);
        if (near) {
            machine.activated = true;
            return;
        }
    }

    // Select unit if clicking on one
    let newSelected = null;
    playerUnits.forEach((u, i) => {
        if (u.hp > 0 && Math.hypot(clickX - u.x, clickY - u.y) < (u.isLeader ? 15 : 10)) {
            newSelected = i;
        }
    });
    if (newSelected !== null) {
        selectedUnit = newSelected;
        return;
    }

    // Move selected unit to spot
    if (selectedUnit !== null) {
        const u = playerUnits[selectedUnit];
        if (u.hp > 0) {
            u.destX = clickX;
            u.destY = clickY;
            if (u.isLeader) {
                // Team follows
                playerUnits.forEach(other => {
                    if (!other.isLeader && other.hp > 0) {
                        other.destX = clickX + (Math.random() - 0.5) * 50;
                        other.destY = clickY + (Math.random() - 0.5) * 50;
                    }
                });
            }
        }
        selectedUnit = null;
    }
});

// Initial draw
drawRuins();
</script>
</body>
</html>
