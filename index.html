<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Horus Heresy – Legion Survival (Visible Fix)</title>
<style>
    body { margin:0; padding:0; background:#000; color:#eee; font-family:Arial, sans-serif; overflow:hidden; }
    #ui { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.7); padding:15px; border:1px solid #fff; z-index:10; }
    #canvas { display:block; }
    button, select { margin:5px; padding:8px; font-size:16px; }
    #objective { position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.7); padding:10px; z-index:5; display:none; font-size:16px; }
</style>
</head>
<body>

<div id="ui">
    <label>Choose Legion:</label><br>
    <select id="legionSelect">
        <option value="">Pick one</option>
        <option value="Dark Angels">I – Dark Angels</option>
        <option value="Emperor's Children">III – Emperor's Children</option>
        <option value="Iron Warriors">IV – Iron Warriors</option>
        <option value="White Scars">V – White Scars</option>
        <option value="Space Wolves">VI – Space Wolves</option>
        <option value="Imperial Fists">VII – Imperial Fists</option>
        <option value="Night Lords">VIII – Night Lords</option>
        <option value="Blood Angels">IX – Blood Angels</option>
        <option value="Iron Hands">X – Iron Hands</option>
        <option value="World Eaters">XII – World Eaters</option>
        <option value="Ultramarines">XIII – Ultramarines</option>
        <option value="Death Guard">XIV – Death Guard</option>
        <option value="Thousand Sons">XV – Thousand Sons</option>
        <option value="Sons of Horus">XVI – Sons of Horus</option>
        <option value="Word Bearers">XVII – Word Bearers</option>
        <option value="Salamanders">XVIII – Salamanders</option>
        <option value="Raven Guard">XIX – Raven Guard</option>
        <option value="Alpha Legion">XX – Alpha Legion</option>
    </select><br>
    <button onclick="startGame()">Deploy</button>
</div>

<canvas id="canvas" width="1400" height="900"></canvas>

<div id="objective">Click a marine to select → click destination to move<br>Click leader (bigger) → squad follows<br>Enemies spawn from top – shoot orange bolts</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const LEGION_COLORS = {
    "Dark Angels": "#2e7d32",
    "Emperor's Children": "#7b1fa2",
    "Iron Warriors": "#616161",
    "White Scars": "#e0e0e0",
    "Space Wolves": "#90caf9",
    "Imperial Fists": "#ffeb3b",
    "Night Lords": "#0d47a1",
    "Blood Angels": "#c62828",
    "Iron Hands": "#212121",
    "World Eaters": "#b71c1c",
    "Ultramarines": "#1976d2",
    "Death Guard": "#558b2f",
    "Thousand Sons": "#283593",
    "Sons of Horus": "#2e7d32",
    "Word Bearers": "#880e4f",
    "Salamanders": "#1b5e20",
    "Raven Guard": "#263238",
    "Alpha Legion": "#00695c"
};

let playerColor = null;
let playerLegionName = "";
let playerUnits = [];
let selectedUnitIndex = null;
let enemies = [];
let buttonActivated = false;

function startGame() {
    const legion = document.getElementById('legionSelect').value;
    if (!legion) {
        alert("Pick a legion first!");
        return;
    }

    playerLegionName = legion;
    playerColor = LEGION_COLORS[legion] || "#888888";

    document.getElementById('ui').style.display = 'none';
    document.getElementById('objective').style.display = 'block';

    // Squad always in center of screen
    playerUnits = [];
    for (let i = 0; i < 11; i++) {
        playerUnits.push({
            x: 700 + (i - 5) * 40,
            y: 450 + Math.floor(i / 4 - 1) * 60,
            destX: null,
            destY: null,
            hp: 100,
            isLeader: i === 5
        });
    }

    spawnEnemies();
    gameLoop();
}

function drawGroundAndDebug() {
    ctx.fillStyle = '#2e4d1a'; // dark green ground
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = 'white';
    ctx.font = '24px Arial';
    ctx.fillText(playerLegionName + " squad here", 500, 80);

    // Machine debug (far up, but visible in this version)
    ctx.fillStyle = '#880000';
    ctx.fillRect(650, 100, 100, 100);
    ctx.fillStyle = 'white';
    ctx.font = '20px Arial';
    ctx.fillText("MACHINE", 670, 150);
}

function drawUnits() {
    playerUnits.forEach((u, i) => {
        if (u.hp <= 0) return;

        const s = u.isLeader ? 20 : 14;

        ctx.fillStyle = playerColor;
        ctx.beginPath();
        ctx.arc(u.x, u.y, s, 0, Math.PI * 2);
        ctx.fill();

        // Helmet
        ctx.fillStyle = '#eeeeee';
        ctx.beginPath();
        ctx.arc(u.x, u.y - s * 0.5, s * 0.6, 0, Math.PI * 2);
        ctx.fill();

        if (u.isLeader) {
            ctx.strokeStyle = "#ffff99";
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(u.x, u.y, s * 1.3, 0, Math.PI * 2);
            ctx.stroke();
        }

        if (selectedUnitIndex === i) {
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(u.x, u.y, s * 1.2, 0, Math.PI * 2);
            ctx.stroke();
        }
    });
}

function drawEnemies() {
    enemies.forEach(e => {
        if (e.hp <= 0) return;
        ctx.fillStyle = '#800000';
        ctx.beginPath();
        ctx.arc(e.x, e.y, 15, 0, Math.PI * 2);
        ctx.fill();
    });
}

function moveUnits() {
    playerUnits.forEach(u => {
        if (u.hp <= 0 || !u.destX) return;
        const dx = u.destX - u.x;
        const dy = u.destY - u.y;
        const dist = Math.hypot(dx, dy);
        if (dist < 5) {
            u.destX = u.destY = null;
            return;
        }
        const speed = u.isLeader ? 3 : 2.5;
        u.x += dx / dist * speed;
        u.y += dy / dist * speed;
    });
}

function enemyAI() {
    enemies.forEach(e => {
        if (e.hp <= 0) return;
        let closest = null;
        let minDist = Infinity;
        playerUnits.forEach(p => {
            if (p.hp > 0) {
                const d = Math.hypot(p.x - e.x, p.y - e.y);
                if (d < minDist) {
                    minDist = d;
                    closest = p;
                }
            }
        });
        if (closest) {
            const dx = closest.x - e.x;
            const dy = closest.y - e.y;
            const dist = Math.hypot(dx, dy);
            if (dist < 30) {
                closest.hp -= 0.6;
            } else {
                e.x += dx / dist * 1.3;
                e.y += dy / dist * 1.3;
            }
        }
    });
}

function playerCombat() {
    playerUnits.forEach(u => {
        if (u.hp <= 0) return;
        let closest = null;
        let minDist = Infinity;
        enemies.forEach(e => {
            if (e.hp > 0) {
                const d = Math.hypot(e.x - u.x, e.y - u.y);
                if (d < 120 && d < minDist) {
                    minDist = d;
                    closest = e;
                }
            }
        });
        if (closest) {
            ctx.strokeStyle = '#ff8800';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(u.x, u.y);
            ctx.lineTo(closest.x, closest.y);
            ctx.stroke();
            closest.hp -= 0.8;
        }
    });
}

function spawnEnemies() {
    setInterval(() => {
        if (buttonActivated) return;
        const num = Math.floor(Math.random() * 6) + 4;
        for (let i = 0; i < num; i++) {
            enemies.push({
                x: Math.random() * canvas.width,
                y: Math.random() * 100 - 150, // spawn off top
                hp: 60 + Math.random() * 50
            });
        }
    }, 7000);
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    drawGroundAndDebug();
    drawUnits();
    drawEnemies();

    moveUnits();
    enemyAI();
    playerCombat();

    requestAnimationFrame(gameLoop);
}

canvas.addEventListener('click', e => {
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;

    let clicked = null;
    playerUnits.forEach((u, i) => {
        if (Math.hypot(clickX - u.x, clickY - u.y) < 25) clicked = i;
    });

    if (clicked !== null) {
        selectedUnitIndex = clicked;
    } else if (selectedUnitIndex !== null) {
        const u = playerUnits[selectedUnitIndex];
        u.destX = clickX;
        u.destY = clickY;
        if (u.isLeader) {
            playerUnits.forEach(other => {
                if (other !== u && other.hp > 0) {
                    other.destX = clickX + (Math.random() - 0.5) * 100;
                    other.destY = clickY + (Math.random() - 0.5) * 100;
                }
            });
        }
        selectedUnitIndex = null;
    }
});

gameLoop(); // start loop early so canvas is active
</script>
</body>
</html>
