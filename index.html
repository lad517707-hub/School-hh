<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Horus Heresy – Legion March</title>
<style>
body{margin:0;background:#000;overflow:hidden;font-family:Arial}
#ui{
 position:absolute;top:10px;left:10px;
 background:rgba(0,0,0,.85);
 color:#eee;padding:12px;
 border:1px solid #444;z-index:10
}
#end{
 position:absolute;inset:0;display:none;
 background:rgba(0,0,40,.92);
 color:#0ff;font-size:32px;
 align-items:center;justify-content:center;
 flex-direction:column;z-index:20
}
canvas{
 image-rendering:pixelated;
 image-rendering:crisp-edges;
 cursor:crosshair
}
</style>
</head>
<body>

<div id="ui">
<select id="legion">
<option value="">— Select Legion —</option>
<option value="dark">Dark Angels</option>
<option value="emperor">Emperor's Children</option>
<option value="iron">Iron Warriors</option>
<option value="white">White Scars</option>
<option value="wolves">Space Wolves</option>
<option value="fists">Imperial Fists</option>
<option value="night">Night Lords</option>
<option value="blood">Blood Angels</option>
<option value="hands">Iron Hands</option>
<option value="world">World Eaters</option>
<option value="ultra">Ultramarines</option>
<option value="death">Death Guard</option>
<option value="thousand">Thousand Sons</option>
<option value="horus">Sons of Horus</option>
<option value="word">Word Bearers</option>
<option value="salamander">Salamanders</option>
<option value="raven">Raven Guard</option>
<option value="alpha">Alpha Legion</option>
</select>
<button onclick="start()">Deploy</button>
<p style="font-size:12px">
Click leader → WASD<br>
Squad follows leader
</p>
</div>

<div id="end">
<h1>VICTORY</h1>
<p>Orbital beam fired.</p>
<button onclick="location.reload()">New Campaign</button>
</div>

<canvas id="c" width="420" height="240"
style="width:1680px;height:960px"></canvas>

<script>
const c=document.getElementById("c");
const x=c.getContext("2d");
x.imageSmoothingEnabled=false;

let camX=700,camY=450;
let units=[],enemies=[],bullets=[];
let leader=null;
let legionColor="#ccc";
let machine={x:700,y:-6000,active:false};
let win=false;

const keys={w:0,a:0,s:0,d:0};
onkeydown=e=>{if(e.key in keys)keys[e.key]=1};
onkeyup=e=>{if(e.key in keys)keys[e.key]=0};

const legionColors={
 dark:"#1e3b2d", emperor:"#b070d6", iron:"#888",
 white:"#ddd", wolves:"#7a8fa6", fists:"#c9a400",
 night:"#1b1b3a", blood:"#8b0000", hands:"#555",
 world:"#a83232", ultra:"#2244cc", death:"#6b8f3f",
 thousand:"#3a2c7a", horus:"#2f5d50", word:"#5b1d1d",
 salamander:"#1f7a3a", raven:"#222", alpha:"#2aa6a6"
};

function start(){
 const l=document.getElementById("legion").value;
 if(!l)return;
 legionColor=legionColors[l]||"#ccc";
 document.getElementById("ui").style.display="none";

 units=[];
 for(let i=0;i<11;i++){
  const u={
   x:700+(i%4)*14-20,
   y:450+Math.floor(i/4)*14,
   offX:(i%4)*14-20,
   offY:Math.floor(i/4)*14,
   leader:i===5,
   hp:100
  };
  units.push(u);
  if(u.leader)leader=u;
 }
 spawnEnemies();
 loop();
}

c.onclick=e=>{
 const r=c.getBoundingClientRect();
 const mx=(e.clientX-r.left)*(c.width/r.width);
 const my=(e.clientY-r.top)*(c.height/r.height);
 const wx=camX+(mx-c.width/2);
 const wy=camY+(my-c.height/2);
 if(Math.hypot(wx-leader.x,wy-leader.y)<12){}
};

function spawnEnemies(){
 setInterval(()=>{
  if(win)return;
  const y=Math.min(...units.map(u=>u.y))-500;
  for(let i=0;i<6;i++)
   enemies.push({x:Math.random()*1400,y:y-Math.random()*300,hp:60});
 },8000);
}

function update(){
 /* LEADER MOVEMENT ONLY */
 let dx=0,dy=0;
 if(keys.w)dy--;
 if(keys.s)dy++;
 if(keys.a)dx--;
 if(keys.d)dx++;
 if(dx||dy){
  const l=Math.hypot(dx,dy);
  dx/=l; dy/=l;
  leader.x+=dx*2.4;
  leader.y+=dy*2.4;
 }

 /* FOLLOWERS MOVE IN UNISON */
 units.forEach(u=>{
  if(!u.leader){
   const tx=leader.x+u.offX;
   const ty=leader.y+u.offY;
   u.x+=(tx-u.x)*0.12;
   u.y+=(ty-u.y)*0.12;
  }
 });

 /* SHOOTING */
 units.forEach(u=>{
  let t=null,d=999;
  enemies.forEach(e=>{
   const m=Math.hypot(e.x-u.x,e.y-u.y);
   if(m<160&&m<d){d=m;t=e;}
  });
  if(t){
   bullets.push({
    x:u.x,y:u.y,
    dx:(t.x-u.x)/d,
    dy:(t.y-u.y)/d,
    life:40
   });
   t.hp-=0.6;
  }
 });

 bullets.forEach(b=>{
  b.x+=b.dx*6;
  b.y+=b.dy*6;
  b.life--;
 });
 bullets=bullets.filter(b=>b.life>0);

 enemies=enemies.filter(e=>e.hp>0);
 enemies.forEach(e=>{
  const d=Math.hypot(leader.x-e.x,leader.y-e.y);
  e.x+=(leader.x-e.x)*0.008;
  e.y+=(leader.y-e.y)*0.008;
 });

 if(Math.hypot(leader.x-machine.x,leader.y-machine.y)<30){
  machine.active=true;
  win=true;
  document.getElementById("end").style.display="flex";
 }

 camX+=(leader.x-camX)*0.1;
 camY+=(leader.y-camY)*0.1;
}

function draw(){
 x.clearRect(0,0,c.width,c.height);
 x.save();
 x.translate(c.width/2,c.height/2);
 x.translate(-camX,-camY);

 /* MAP */
 x.fillStyle="#2a3d1a";
 x.fillRect(-2000,-8000,4000,9000);
 x.fillStyle="#1e4a7a";
 x.fillRect(200,-4000,1000,180);

 x.fillStyle="#4a3728";
 for(let i=0;i<6;i++)
  x.fillRect(300+i*200,-2000+i*300,80,60);

 /* MACHINE */
 if(Math.abs(camY-machine.y)<800){
  x.fillStyle="#444";
  x.fillRect(machine.x-20,machine.y-20,40,40);
  x.fillStyle=machine.active?"#0ff":"#800";
  x.beginPath();
  x.arc(machine.x,machine.y,10,0,Math.PI*2);
  x.fill();
 }

 if(machine.active){
  x.strokeStyle="#0ff";
  x.lineWidth=20;
  x.beginPath();
  x.moveTo(machine.x,machine.y);
  x.lineTo(machine.x,machine.y-2000);
  x.stroke();
 }

 /* ENEMIES */
 enemies.forEach(e=>{
  x.fillStyle="#600";
  x.fillRect(e.x-4,e.y-4,8,8);
 });

 /* UNITS */
 units.forEach(u=>{
  x.fillStyle=u.leader?"#ff0":legionColor;
  x.fillRect(u.x-4,u.y-4,8,8);
 });

 /* BULLETS */
 bullets.forEach(b=>{
  x.strokeStyle="#f80";
  x.beginPath();
  x.moveTo(b.x,b.y);
  x.lineTo(b.x-b.dx*4,b.y-b.dy*4);
  x.stroke();
 });

 x.restore();
}

function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
</script>
</body>
</html>
