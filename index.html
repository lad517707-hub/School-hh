<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>D&D Text Game – Fresh Start</title>
<style>
    body {
        margin: 0;
        padding: 0;
        background: #0a1f0a;
        color: #d4ffcc;
        font-family: Arial, Helvetica, sans-serif;
        min-height: 100vh;
        text-align: center;
    }

    #creation, #game, #death {
        display: none;
        padding: 30px;
    }

    h1, h2 {
        color: #8bc34a;
        text-shadow: 0 0 10px #4caf50;
    }

    button {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 14px 32px;
        margin: 12px 8px;
        font-size: 17px;
        cursor: pointer;
        border-radius: 6px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }

    button:hover { background: #66bb6a; transform: translateY(-1px); }

    select, input {
        padding: 12px;
        font-size: 16px;
        margin: 8px;
        background: #1b2e1b;
        color: #d4ffcc;
        border: 2px solid #4caf50;
        border-radius: 4px;
        width: 280px;
        max-width: 90%;
    }

    #dm-box {
        background: rgba(27,46,27,0.85);
        border: 3px solid #4caf50;
        padding: 20px;
        margin: 25px auto;
        max-width: 720px;
        font-size: 15px;
        line-height: 1.5;
        border-radius: 8px;
        text-align: left;
    }

    .combat-zone {
        display: flex;
        justify-content: center;
        gap: 100px;
        margin: 40px 0;
        flex-wrap: wrap;
    }

    .char-side {
        text-align: center;
    }

    .pixel-character {
        width: 120px;
        height: 160px;
        margin: 0 auto 15px;
        background: #2e4a2e;
        border: 4px solid #4caf50;
        position: relative;
        image-rendering: pixelated;
    }

    .head { width: 50px; height: 50px; background: #c8e6c9; border-radius: 50%; position: absolute; top: 10px; left: 35px; }
    .body { width: 60px; height: 80px; background: #388e3c; position: absolute; top: 55px; left: 30px; border-radius: 12px; }

    .health-bar-outer {
        width: 180px;
        height: 24px;
        background: #1b2e1b;
        border: 3px solid #388e3c;
        margin: 12px auto;
        border-radius: 6px;
        overflow: hidden;
        position: relative;
    }

    .health-bar-inner {
        height: 100%;
        background: linear-gradient(to right, #66bb6a, #8bc34a);
        width: 100%;
        transition: width 0.5s ease;
    }

    .hp-label {
        position: absolute;
        inset: 0;
        color: #0a1f0a;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        text-shadow: 1px 1px 0 #d4ffcc;
    }

    #death {
        position: fixed;
        inset: 0;
        background: #000;
        color: #ff5252;
        font-size: 38px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
</style>
</head>
<body>

<div id="creation">
    <h1>D&D Adventure</h1>
    <h2>Character Creation</h2>

    <label>Race</label><br>
    <select id="race">
        <option value="human">Human</option>
        <option value="elf">Elf</option>
        <option value="dwarf">Dwarf</option>
        <option value="orc">Orc</option>
    </select><br><br>

    <label>Class</label><br>
    <select id="class">
        <option value="fighter">Fighter</option>
        <option value="wizard">Wizard</option>
        <option value="rogue">Rogue</option>
        <option value="cleric">Cleric</option>
    </select><br><br>

    <label>Level (1–5)</label><br>
    <input type="number" id="level" value="1" min="1" max="5"><br><br>

    <label>Weapons (comma separated)</label><br>
    <input type="text" id="weapons" value="Shortsword"><br><br>

    <label>Armor</label><br>
    <input type="text" id="armor" value="Leather"><br><br>

    <label>Spells (comma separated)</label><br>
    <input type="text" id="spells" value="Firebolt"><br><br>

    <label>Inventory (comma separated)</label><br>
    <input type="text" id="inventory" value="Healing Potion x2"><br><br>

    <button onclick="startNewGame()">Begin Quest</button>
</div>

<div id="game">
    <h1 id="quest-title">Quest</h1>

    <div class="combat-zone">
        <div class="char-side">
            <div class="pixel-character" id="player-char">
                <div class="head"></div>
                <div class="body"></div>
            </div>
            <div class="health-bar-outer">
                <div class="health-bar-inner" id="player-hp-fill"></div>
                <div class="hp-label" id="player-hp-label">HP: 30 / 30</div>
            </div>
            <div id="player-info"></div>
        </div>

        <div class="char-side">
            <div class="pixel-character" id="enemy-char" style="display:none;">
                <div class="head" style="background:#ff8a65;"></div>
                <div class="body" style="background:#ef5350;"></div>
            </div>
            <div class="health-bar-outer" id="enemy-hp-outer" style="display:none;">
                <div class="health-bar-inner" id="enemy-hp-fill"></div>
                <div class="hp-label" id="enemy-hp-label"></div>
            </div>
            <div id="enemy-name"></div>
        </div>
    </div>

    <div id="dm-box">
        <strong>DM:</strong> <span id="dm-text">Welcome, Elias. The tale begins...</span>
    </div>

    <div id="action-area"></div>

    <div id="roll-area" style="display:none; margin:30px 0;">
        <button onclick="rollD20()">Roll d20</button>
        <div id="roll-result" style="font-size:22px; margin-top:16px; min-height:30px;"></div>
    </div>
</div>

<div id="death">
    You and your fellow warriors have fallen.<br>
    <span style="font-size:28px; margin:30px 0; display:block;">Rise up.</span>
    <button onclick="startNewGame()">New Journey</button>
</div>

<script>
// ─────────────────────────────────────────────
// Global state – fully reset on new game
// ─────────────────────────────────────────────
let state = {
    playerHP: 30,
    playerMaxHP: 30,
    inCombat: false,
    enemyHP: 0,
    enemyMaxHP: 0,
    enemyName: "",
    currentAction: null
};

function resetGameState() {
    state = {
        playerHP: 30,
        playerMaxHP: 30,
        inCombat: false,
        enemyHP: 0,
        enemyMaxHP: 0,
        enemyName: "",
        currentAction: null
    };
}

function startNewGame() {
    resetGameState();

    // Read form if creation is visible
    if (document.getElementById("creation").style.display !== "none") {
        const cls = document.getElementById("class").value;
        const lvl = parseInt(document.getElementById("level").value) || 1;

        state.playerMaxHP = 18 + lvl * 6 + (cls === "fighter" ? 10 : 0);
        state.playerHP = state.playerMaxHP;
    }

    // Hide death & game, show creation or game
    document.getElementById("death").style.display = "none";
    document.getElementById("game").style.display = "none";
    document.getElementById("creation").style.display = "block";

    // If we already have a character, skip creation
    if (state.playerHP > 0 && state.playerMaxHP > 0) {
        enterGame();
    }
}

function enterGame() {
    document.getElementById("creation").style.display = "none";
    document.getElementById("game").style.display = "block";
    document.getElementById("death").style.display = "none";

    updatePlayerHealth();
    dmSpeak("Elias, you awaken in a dark wood. A path lies ahead...");

    // Simple first encounter
    setTimeout(() => startCombat("Goblin Scout", 20), 800);
}

function updatePlayerHealth() {
    const perc = Math.max(0, Math.min(100, (state.playerHP / state.playerMaxHP) * 100));
    document.getElementById("player-hp-fill").style.width = perc + "%";
    document.getElementById("player-hp-label").textContent = `HP: ${state.playerHP} / ${state.playerMaxHP}`;

    if (state.playerHP <= 0) {
        document.getElementById("game").style.display = "none";
        document.getElementById("death").style.display = "flex";
    }
}

function dmSpeak(text) {
    document.getElementById("dm-text").textContent = text;
}

function startCombat(name, hp) {
    state.enemyName = name;
    state.enemyMaxHP = hp;
    state.enemyHP = hp;
    state.inCombat = true;

    document.getElementById("enemy-char").style.display = "block";
    document.getElementById("enemy-hp-outer").style.display = "block";
    updateEnemyHealth();

    dmSpeak(`A ${name} appears! What do you do?`);

    showActions([
        {txt:"Attack (Weapon)", act:() => beginAction("weapon")},
        {txt:"Cast Spell",      act:() => beginAction("spell")},
        {txt:"Use Potion",      act:() => usePotion()},
        {txt:"Run",             act:() => tryRun()}
    ]);
}

function updateEnemyHealth() {
    const perc = Math.max(0, (state.enemyHP / state.enemyMaxHP) * 100);
    document.getElementById("enemy-hp-fill").style.width = perc + "%";
    document.getElementById("enemy-hp-label").textContent = `${state.enemyName} HP: ${state.enemyHP}/${state.enemyMaxHP}`;
}

function beginAction(type) {
    state.currentAction = type;
    document.getElementById("roll-area").style.display = "block";
    document.getElementById("action-area").innerHTML = "";
    document.getElementById("roll-result").textContent = `Roll d20 for ${type}...`;
}

function rollD20() {
    if (!state.inCombat || !state.currentAction) return;

    const roll = Math.floor(Math.random() * 20) + 1;
    let msg = `Rolled ${roll} – `;

    if (roll <= 9) {
        msg += "miss!";
    } else {
        let dmg = roll - 9;
        if (roll === 20) dmg *= 2;
        msg += `hit for ${dmg} damage!`;

        state.enemyHP -= dmg;
        if (state.enemyHP < 0) state.enemyHP = 0;
        updateEnemyHealth();

        if (state.enemyHP <= 0) {
            dmSpeak(`The ${state.enemyName} falls! Victory.`);
            endCombat();
            return;
        }
    }

    document.getElementById("roll-result").textContent = msg;
    document.getElementById("roll-area").style.display = "none";

    setTimeout(enemyTurn, 900);
}

function enemyTurn() {
    const roll = Math.floor(Math.random() * 20) + 1;
    let msg = `Enemy rolls ${roll} → `;

    if (roll <= 9) {
        msg += "misses!";
    } else {
        let dmg = roll - 9;
        if (roll === 20) dmg *= 2;
        state.playerHP -= dmg;
        if (state.playerHP < 0) state.playerHP = 0;
        msg += `hits for ${dmg} damage!`;
        updatePlayerHealth();

        if (state.playerHP <= 0) {
            document.getElementById("game").style.display = "none";
            document.getElementById("death").style.display = "flex";
            return;
        }
    }

    dmSpeak(msg);
    showActions();
}

function usePotion() {
    const hasPotion = player.inventory.some(i => i.toLowerCase().includes("potion"));
    if (!hasPotion) {
        dmSpeak("No potions left.");
        return;
    }

    // Remove one potion
    for (let i = 0; i < player.inventory.length; i++) {
        if (player.inventory[i].toLowerCase().includes("potion")) {
            player.inventory.splice(i, 1);
            break;
        }
    }

    const heal = 12;
    state.playerHP = Math.min(state.playerMaxHP, state.playerHP + heal);
    updatePlayerHealth();
    dmSpeak(`You drink a healing potion and recover ${heal} HP.`);

    setTimeout(enemyTurn, 800);
}

function tryRun() {
    if (Math.random() < 0.65) {
        dmSpeak("You escape into the mist!");
        endCombat();
    } else {
        dmSpeak("No escape! The enemy strikes.");
        enemyTurn();
    }
}

function endCombat() {
    state.inCombat = false;
    state.currentAction = null;
    document.getElementById("enemy-char").style.display = "none";
    document.getElementById("enemy-hp-outer").style.display = "none";
    document.getElementById("roll-area").style.display = "none";
    document.getElementById("action-area").innerHTML = "";

    dmSpeak("The fight is over. The path continues...");
    setTimeout(() => dmSpeak("What do you do next?"), 1200);
}

function showActions(list = null) {
    const area = document.getElementById("action-area");
    area.innerHTML = "";

    if (!list) {
        list = [
            {txt:"Attack (Weapon)", act:() => beginAction("weapon")},
            {txt:"Cast Spell",      act:() => beginAction("spell")},
            {txt:"Use Potion",      act:() => usePotion()},
            {txt:"Run",             act:() => tryRun()}
        ];
    }

    list.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item.txt;
        btn.onclick = item.act;
        area.appendChild(btn);
    });
}

// ────────────────────────────────────────
// Kick-off
// ────────────────────────────────────────
resetGameState();
document.getElementById("creation").style.display = "block";
</script>
</body>
</html>
