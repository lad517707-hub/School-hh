<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Horus Heresy â€“ Legion Survival</title>
<style>
    body { margin:0; padding:0; background:#000; color:#eee; font-family:Arial, sans-serif; overflow:hidden; }
    #ui { position:absolute; top:15px; left:15px; background:rgba(10,10,30,0.85); padding:20px; border:1px solid #444; border-radius:10px; z-index:10; max-width:340px; }
    #canvas { display:block; cursor:crosshair; image-rendering:pixelated; }
    button, select { padding:10px 16px; margin:8px 6px 8px 0; font-size:15px; background:#1a1a3a; color:#eee; border:1px solid #555; border-radius:6px; cursor:pointer; }
    button:hover { background:#2a2a5a; }
    #story { position:absolute; inset:0; background:rgba(0,0,20,0.92); z-index:20; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:50px; text-align:center; font-size:19px; line-height:1.6; }
    #story button { font-size:22px; padding:15px 40px; margin-top:40px; }
    #objective { position:absolute; bottom:20px; left:20px; background:rgba(0,0,0,0.7); padding:12px 20px; border-radius:8px; font-size:16px; max-width:600px; z-index:5; display:none; }
    #endScreen { position:absolute; inset:0; background:rgba(0,0,20,0.92); z-index:20; display:none; flex-direction:column; justify-content:center; align-items:center; padding:50px; text-align:center; font-size:28px; line-height:1.6; }
</style>
</head>
<body>

<div id="story">
    <h1>Abandoned Outpost â€“ Forgotten World</h1>
    <p>Your squad awakens in the ruins of an ancient settlement â€” crumbling stone walls, wooden shacks, a broken bridge over a sluggish river.<br>
    Warp-tainted creatures prowl the shadows. The path ahead is long and treacherous.<br><br>
    Lead your 10 battle-brothers and yourself to the distant machine. Activate the red button to call for orbital support.<br>
    The ground behind you crumbles as you advance â€” no turning back.</p>
    <button onclick="document.getElementById('story').style.display='none'">Begin Mission</button>
</div>

<div id="ui">
    <label><strong>Choose your Legion:</strong></label><br>
    <select id="legionSelect">
        <option value="">â€” Select Legion â€”</option>
        <option value="Dark Angels">I â€“ Dark Angels</option>
        <option value="Emperor's Children">III â€“ Emperor's Children</option>
        <option value="Iron Warriors">IV â€“ Iron Warriors</option>
        <option value="White Scars">V â€“ White Scars</option>
        <option value="Space Wolves">VI â€“ Space Wolves</option>
        <option value="Imperial Fists">VII â€“ Imperial Fists</option>
        <option value="Night Lords">VIII â€“ Night Lords</option>
        <option value="Blood Angels">IX â€“ Blood Angels</option>
        <option value="Iron Hands">X â€“ Iron Hands</option>
        <option value="World Eaters">XII â€“ World Eaters</option>
        <option value="Ultramarines">XIII â€“ Ultramarines</option>
        <option value="Death Guard">XIV â€“ Death Guard</option>
        <option value="Thousand Sons">XV â€“ Thousand Sons</option>
        <option value="Sons of Horus">XVI â€“ Sons of Horus</option>
        <option value="Word Bearers">XVII â€“ Word Bearers</option>
        <option value="Salamanders">XVIII â€“ Salamanders</option>
        <option value="Raven Guard">XIX â€“ Raven Guard</option>
        <option value="Alpha Legion">XX â€“ Alpha Legion</option>
    </select><br>
    <button onclick="startCampaign()">Deploy</button>
</div>

<canvas id="canvas" width="1400" height="900"></canvas>

<div id="objective">Select a marine (click on him), then click destination to move.<br>Click your leader (YOU) to make squad follow in formation.<br>Use mouse wheel to zoom in/out for details. Advance forward â€” the path behind fades.</div>

<div id="endScreen">
    <h1>Victory â€“ Beam Activated</h1>
    <p>The crimson button glows. A blinding blue beam lances into the heavens.<br>Reinforcements inbound. The outpost is secured... for the Emperor (or the Warmaster).</p>
    <button onclick="location.reload()">New Campaign</button>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let playerColor = null;
let playerLegionName = "";
let playerUnits = [];
let selectedUnitIndex = null;
let enemies = [];
let machinePos = {x: 700, y: -3000};
let buttonActivated = false;
let zoom = 1;
let cameraX = 700;
let cameraY = 800;
let worldObjects = [];

const LEGION_DETAILS = {
    "Dark Angels": {main: "#2e7d32", accent: "#1b5e20", symbol: "sword", pad: "wing"},
    "Emperor's Children": {main: "#7b1fa2", accent: "#d500f9", symbol: "eagle", pad: "gem"},
    "Iron Warriors": {main: "#616161", accent: "#424242", symbol: "skull", pad: "hazard"},
    "White Scars": {main: "#e0e0e0", accent: "#ffffff", symbol: "lightning", pad: "scar"},
    "Space Wolves": {main: "#90caf9", accent: "#bbdefb", symbol: "wolf", pad: "pelt"},
    "Imperial Fists": {main: "#ffeb3b", accent: "#fdd835", symbol: "fist", pad: "castle"},
    "Night Lords": {main: "#0d47a1", accent: "#1565c0", symbol: "bat", pad: "wingdark"},
    "Blood Angels": {main: "#c62828", accent: "#b71c1c", symbol: "drop", pad: "blood"},
    "Iron Hands": {main: "#212121", accent: "#424242", symbol: "hand", pad: "metal"},
    "World Eaters": {main: "#b71c1c", accent: "#d32f2f", symbol: "axe", pad: "chain"},
    "Ultramarines": {main: "#1976d2", accent: "#1565c0", symbol: "U", pad: "laurel"},
    "Death Guard": {main: "#558b2f", accent: "#33691e", symbol: "fly", pad: "rot"},
    "Thousand Sons": {main: "#283593", accent: "#4527a0", symbol: "eye", pad: "rune"},
    "Sons of Horus": {main: "#2e7d32", accent: "#1b5e20", symbol: "eye", pad: "lupercal"},
    "Word Bearers": {main: "#880e4f", accent: "#ad1457", symbol: "book", pad: "cog"},
    "Salamanders": {main: "#1b5e20", accent: "#2e7d32", symbol: "flame", pad: "drake"},
    "Raven Guard": {main: "#263238", accent: "#37474f", symbol: "raven", pad: "claw"},
    "Alpha Legion": {main: "#00695c", accent: "#004d40", symbol: "hydra", pad: "scale"}
};

function generateMap() {
    worldObjects = [];
    let pathY = 900;
    while (pathY > machinePos.y - 200) {
        worldObjects.push({type: 'path', x: 500 + Math.sin(pathY / 200) * 200, y: pathY, w: 400, h: 100});
        pathY -= 100;
    }
    for (let i = 0; i < 8; i++) {
        let ry = Math.random() * 6000 - 3000;
        worldObjects.push({type: 'river', x: 200 + Math.random() * 800, y: ry, w: 1000, h: 180});
        if (Math.random() > 0.5) worldObjects.push({type: 'bridge', x: 600 + Math.random() * 200, y: ry + 50});
        if (Math.random() > 0.7) worldObjects.push({type: 'boat', x: 680 + Math.random() * 200, y: ry + 80});
    }
    for (let i = 0; i < 80; i++) {
        let objY = Math.random() * 6000 - 3000;
        let objX = Math.random() * 1400;
        let r = Math.random();
        if (r < 0.2) worldObjects.push({type: 'ruin', x: objX, y: objY, w: 100 + Math.random()*100, h: 80 + Math.random()*80, col: "#4a3728"});
        else if (r < 0.3) worldObjects.push({type: 'log', x: objX, y: objY});
        else if (r < 0.4) worldObjects.push({type: 'stoneWall', x: objX, y: objY, len: 200 + Math.random()*200});
        else if (r < 0.6) worldObjects.push({type: 'flower', x: objX, y: objY, count: 4 + Math.floor(Math.random()*6)});
        else if (r < 0.8) worldObjects.push({type: 'tree', x: objX, y: objY, size: 30 + Math.random()*40});
        else worldObjects.push({type: 'rock', x: objX, y: objY, size: 20 + Math.random()*30});
    }
}

function startCampaign() {
    const sel = document.getElementById('legionSelect').value;
    if (!sel) return alert("Select your Legion!");
    playerLegionName = sel;
    playerColor = LEGION_DETAILS[sel]?.main || "#888888";
    document.getElementById('ui').style.display = 'none';
    document.getElementById('objective').style.display = 'block';

    generateMap();

    playerUnits = [];
    for(let i=0; i<11; i++){
        playerUnits.push({
            x: 620 + (i-5)*18,
            y: 780 + Math.random()*20 -10,
            destX:null, destY:null,
            hp:100,
            isLeader: i===5
        });
    }

    spawnEnemies();
    requestAnimationFrame(gameLoop);
}

function drawLegionnaire(x, y, details, size = 11, isLeader = false, zoomLevel) {
    const s = size * (isLeader ? 1.45 : 1);

    // Torso / base armor
    ctx.fillStyle = details.main;
    ctx.beginPath();
    ctx.ellipse(x, y, s*0.9, s*1.1, 0, 0, Math.PI*2);
    ctx.fill();

    // Helmet
    ctx.fillStyle = details.accent || details.main;
    ctx.beginPath();
    ctx.arc(x, y - s*0.65, s*0.55, 0, Math.PI*2);
    ctx.fill();

    // Shoulder pads (larger, legion style)
    ctx.fillStyle = details.accent;
    ctx.beginPath();
    ctx.arc(x - s*0.9, y - s*0.35, s*0.65, 0, Math.PI*2);
    ctx.arc(x + s*0.9, y - s*0.35, s*0.65, 0, Math.PI*2);
    ctx.fill();

    // Chest symbol / aquila approximation
    if (zoomLevel > 1.4) {
        ctx.fillStyle = "#ffffffaa";
        ctx.font = `${s*1.1}px Arial`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        let sym = "âš”";
        switch(details.symbol) {
            case "sword": sym = "â€ "; break;
            case "eagle": sym = "ðŸ¦…"; break;
            case "skull": sym = "â˜ "; break;
            case "lightning": sym = "âš¡"; break;
            case "wolf": sym = "ðŸº"; break;
            case "fist": sym = "âœŠ"; break;
            case "bat": sym = "ðŸ¦‡"; break;
            case "drop": sym = "ðŸ’§"; break;
            case "hand": sym = "ðŸ¤–"; break;
            case "axe": sym = "ðŸª“"; break;
            case "U": sym = "U"; break;
            case "fly": sym = "ðŸª°"; break;
            case "eye": sym = "ðŸ‘"; break;
            case "book": sym = "ðŸ“–"; break;
            case "flame": sym = "ðŸ”¥"; break;
            case "raven": sym = "ðŸ¦…"; break;
            case "hydra": sym = "ðŸ‰"; break;
        }
        ctx.fillText(sym, x, y);
    }

    if (isLeader) {
        ctx.strokeStyle = "#ffff99";
        ctx.lineWidth = 4 / zoomLevel;
        ctx.beginPath();
        ctx.arc(x, y, s*1.35, 0, Math.PI*2);
        ctx.stroke();
    }
}

function drawUnits() {
    ctx.shadowColor = 'rgba(0,0,0,0.6)';
    ctx.shadowBlur = 8 / zoom;
    ctx.shadowOffsetX = 6 / zoom;
    ctx.shadowOffsetY = 6 / zoom;

    playerUnits.forEach((u,i) => {
        if(u.hp<=0) return;
        const details = LEGION_DETAILS[playerLegionName] || {main: playerColor, accent: playerColor, symbol: "?"};
        drawLegionnaire(u.x, u.y, details, 11, u.isLeader, zoom);

        if(selectedUnitIndex === i){
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 3 / zoom;
            ctx.beginPath();
            ctx.arc(u.x, u.y, u.isLeader ? 22 : 16, 0, Math.PI*2);
            ctx.stroke();
        }
    });

    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// The rest of the game code (drawWorld, drawRuin, drawBridge, etc.) remains unchanged from previous version
// Paste the complete previous game logic here (generateMap, drawWorld, moveUnits, enemyAI, playerCombat, spawnEnemies, gameLoop, event listeners, etc.)

// For brevity in this response, I'm showing only the changed parts.
// In practice, combine this with the full previous code you had.

function gameLoop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.scale(zoom, zoom);
    ctx.translate(-cameraX, -cameraY);

    drawWorld();          // â† your procedural map function
    drawUnits();          // â† now uses detailed legion models
    drawEnemies();        // â† your enemy draw function
    drawFadeBehind();     // â† fading behind squad

    ctx.restore();

    // Auto-follow leader
    const leader = playerUnits.find(u => u.isLeader && u.hp > 0);
    if (leader) {
        cameraX += (leader.x - cameraX) * 0.1;
        cameraY += (leader.y - cameraY) * 0.1;
    }

    moveUnits();
    enemyAI();
    playerCombat();
    checkActivation();

    enemies = enemies.filter(e=>e.hp>0);
    playerUnits = playerUnits.filter(u=>u.hp>0);

    requestAnimationFrame(gameLoop);
}

// ... rest of functions (spawnEnemies, checkActivation, click handler, wheel zoom, etc.) as in previous working version

// Initial call (optional preview)
drawWorld();
</script>
</body>
</html>
