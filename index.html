<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Legion Game</title>
<style>
 html,body{margin:0;overflow:hidden;background:#000}
 canvas{image-rendering:pixelated}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
const c=document.getElementById("c");
const ctx=c.getContext("2d");
c.width=innerWidth;
c.height=innerHeight;

// ================= CAMERA =================
let camX=0,camY=0;

// ================= UTIL =================
function hexToRgb(h){
 const n=parseInt(h.slice(1),16);
 return{r:(n>>16)&255,g:(n>>8)&255,b:n&255};
}

// ================= WORLD =================
const TILE=64;
function drawGround(){
 for(let x=-12;x<18;x++){
  for(let y=-12;y<18;y++){
   const wx=Math.floor((camX+x*TILE)/TILE);
   const wy=Math.floor((camY+y*TILE)/TILE);
   const px=wx*TILE-camX;
   const py=wy*TILE-camY;

   ctx.fillStyle="#2f6b2f";
   ctx.fillRect(px,py,TILE,TILE);

   if((wx+wy)%7===0){
    ctx.fillStyle="#1f4f1f";
    ctx.fillRect(px+18,py+18,28,28);
   }
   if((wx*wy)%11===0){
    ctx.fillStyle="#555";
    ctx.fillRect(px+10,py+34,44,20);
   }
   if((wx+wy)%19===0){
    ctx.fillStyle="#1e90ff";
    ctx.fillRect(px,py+44,TILE,20);
   }
  }
 }
}

// ================= UNITS =================
const units=[];
let playerColor="#ff0000";

function spawnSquad(){
 units.length=0;
 for(let i=0;i<6;i++){
  units.push({
   x:200+i*18,y:200,
   leader:i===0,
   hp:100
  });
 }
}

function drawMarine(u){
 const x=u.x-camX;
 const y=u.y-camY;
 ctx.fillStyle=u.leader?"#ffeb3b":playerColor;
 ctx.fillRect(x-4,y-8,8,12);
 ctx.fillRect(x-5,y-10,10,4);
 ctx.fillStyle="#222";
 ctx.fillRect(x+4,y-4,6,2);
}

// ================= INPUT =================
const keys={};
addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

addEventListener("click",e=>{
 const mx=e.clientX+camX,my=e.clientY+camY;
 units.forEach(u=>u.leader=false);
 let best=null,d=1e9;
 units.forEach(u=>{
  const dist=Math.hypot(u.x-mx,u.y-my);
  if(dist<d){d=dist;best=u;}
 });
 if(best)best.leader=true;
});

// ================= BULLETS =================
const bullets=[];
addEventListener("mousedown",()=>{
 const l=units.find(u=>u.leader);
 bullets.push({x:l.x,y:l.y,dx:8,dy:0,life:80});
});

// ================= MONSTERS =================
const monsters=[];

function spawnMonster(big=false){
 monsters.push({
  x:camX+Math.random()*c.width,
  y:camY+Math.random()*c.height,
  big,
  hp:big?300:80,
  max:big?300:80
 });
}

// === MONSTER SPRITES (PIXEL ART)
function drawMonster(m){
 const x=m.x-camX;
 const y=m.y-camY;

 if(m.big){
  // BIG MONSTER
  ctx.fillStyle="#4b0082";
  ctx.fillRect(x-18,y-18,36,36);
  ctx.fillStyle="#8b0000";
  ctx.fillRect(x-12,y-6,24,12);
  ctx.fillStyle="#fff";
  ctx.fillRect(x-10,y-10,4,4);
  ctx.fillRect(x+6,y-10,4,4);

  // HP BAR
  ctx.fillStyle="#000";
  ctx.fillRect(x-18,y-26,36,5);
  ctx.fillStyle="#f00";
  ctx.fillRect(x-18,y-26,36*(m.hp/m.max),5);

 }else{
  // SMALL MONSTER
  ctx.fillStyle="#551a8b";
  ctx.fillRect(x-8,y-8,16,16);
  ctx.fillStyle="#fff";
  ctx.fillRect(x-4,y-4,3,3);
  ctx.fillRect(x+1,y-4,3,3);
 }
}

// ================= BUTTON =================
const button={x:2200,y:1800,pressed:false};

function drawButton(){
 if(Math.hypot(button.x-camX,button.y-camY)>900)return;
 ctx.fillStyle="#555";
 ctx.fillRect(button.x-camX-20,button.y-camY-20,40,40);
 if(button.pressed){
  ctx.strokeStyle="#00f";
  ctx.lineWidth=4;
  ctx.beginPath();
  ctx.moveTo(button.x-camX,button.y-camY);
  ctx.lineTo(button.x-camX,button.y-camY-900);
  ctx.stroke();
 }
}

// ================= LOOP =================
function update(){
 const leader=units.find(u=>u.leader);
 if(leader){
  if(keys.w)leader.y-=3;
  if(keys.s)leader.y+=3;
  if(keys.a)leader.x-=3;
  if(keys.d)leader.x+=3;
  camX=leader.x-c.width/2;
  camY=leader.y-c.height/2;
 }

 units.forEach(u=>{
  if(!u.leader){
   u.x+=(leader.x-u.x)*0.06;
   u.y+=(leader.y-u.y)*0.06;
  }
 });

 bullets.forEach(b=>{
  b.x+=b.dx;b.life--;
  monsters.forEach(m=>{
   if(Math.hypot(b.x-m.x,b.y-m.y)<(m.big?20:10)){
    m.hp-=20;
    b.life=0;
   }
  });
 });

 for(let i=bullets.length-1;i>=0;i--){
  if(bullets[i].life<=0)bullets.splice(i,1);
 }

 for(let i=monsters.length-1;i>=0;i--){
  const m=monsters[i];
  m.x+=(leader.x-m.x)*(m.big?0.002:0.006);
  m.y+=(leader.y-m.y)*(m.big?0.002:0.006);
  if(m.hp<=0)monsters.splice(i,1);
 }

 if(Math.random()<0.02)spawnMonster(false);
 if(Math.random()<0.005)spawnMonster(true);

 if(!button.pressed && Math.hypot(leader.x-button.x,leader.y-button.y)<40){
  button.pressed=true;
 }
}

function draw(){
 ctx.clearRect(0,0,c.width,c.height);
 drawGround();

 monsters.forEach(drawMonster);

 bullets.forEach(b=>{
  ctx.fillStyle="#ff0";
  ctx.fillRect(b.x-camX,b.y-camY,4,2);
 });

 units.forEach(drawMarine);
 drawButton();

 const hp=units.reduce((a,b)=>a+b.hp,0)/(units.length*100);
 ctx.fillStyle="#000";
 ctx.fillRect(20,20,200,12);
 ctx.fillStyle="#0f0";
 ctx.fillRect(20,20,200*hp,12);
}

function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}

// ================= START =================
spawnSquad();
loop();
</script>
</body>
</html>
