<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dungeon Master D&D - Pixel Edition (Fixed)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body {
            font-family: 'Press Start 2P', monospace;
            margin: 0;
            padding: 0;
            background-color: #0f380f;
            color: #e0f8d0;
            text-align: center;
            overflow-x: hidden;
        }
        #container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        h1 { color: #8bac0f; text-shadow: 2px 2px 0 #0f574f; }
        button {
            background: linear-gradient(#306230, #38b554);
            color: #0f380f;
            border: 2px solid #8bac0f;
            padding: 12px 24px;
            margin: 10px 4px;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            border-radius: 0;
            box-shadow: 2px 2px 0 #0f574f;
        }
        button:hover { background: linear-gradient(#38b554, #8bac0f); transform: translateY(-1px); }
        select, input {
            padding: 10px;
            margin: 5px;
            background: #0f574f;
            color: #e0f8d0;
            border: 2px solid #306230;
            font-family: inherit;
            font-size: 10px;
        }
        #dm-narration {
            background: rgba(15,87,79,0.9);
            border: 3px solid #8bac0f;
            padding: 16px;
            margin: 20px 0;
            font-size: 11px;
            line-height: 1.5;
            max-height: 160px;
            overflow-y: auto;
            text-align: left;
        }
        #creation, #game, #death { display: none; }
        .combat-area {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            margin: 30px 0;
            gap: 60px;
        }
        .model-container { position: relative; width: 160px; }
        .pixel-model {
            width: 128px;
            height: 128px;
            margin: 0 auto;
            image-rendering: pixelated;
            border: 3px solid #8bac0f;
            box-shadow: 0 0 10px #8bac0f;
            animation: idle 2s infinite alternate;
            display: grid;
            grid-template-columns: repeat(16, 8px);
            grid-template-rows: repeat(16, 8px);
            gap: 0;
            background: #0f380f;
        }
        @keyframes idle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        .attack { animation: attack 0.4s; }
        @keyframes attack { 0% { transform: scale(1); } 40% { transform: scale(1.15) rotate(8deg); } 100% { transform: scale(1); } }
        .px { background: #0f380f; }
        .px-skin { background: #c0c0c0; }
        .px-clothes { background: #306230; }
        .px-hair { background: #8bac0f; }
        .px-dark { background: #0f574f; }
        .px-light { background: #e0f8d0; }
        .px-red { background: #ff5252; }
        .px-green { background: #38b554; }
        .px-gold { background: #ffdd57; }
        .stats-bar {
            position: absolute;
            bottom: -55px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15,87,79,0.95);
            padding: 8px 12px;
            border: 2px solid #8bac0f;
            font-size: 9px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .model-container:hover .stats-bar { opacity: 1; }
        .health-bar {
            width: 140px;
            height: 16px;
            background: #0f380f;
            border: 2px solid #306230;
            margin: 10px auto;
            overflow: hidden;
        }
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #38b554, #8bac0f);
            transition: width 0.5s ease;
        }
        #story { font-size: 12px; padding: 20px; background: rgba(15,56,15,0.8); border: 3px solid #306230; margin: 20px 0; min-height: 100px; }
        #action-buttons { margin: 20px 0; }
        #death {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #ff5252;
        }
        .bg-forest { background: linear-gradient(to bottom, #0f574f, #0f380f, #306230); }
    </style>
</head>
<body class="bg-forest">

<div id="container">
    <div id="creation">
        <h1>Summon the Dungeon Master</h1>
        <label>Race:</label><br>
        <select id="race">
            <option value="human">Human</option>
            <option value="elf">Elf</option>
            <option value="dwarf">Dwarf</option>
            <option value="orc">Orc</option>
        </select><br><br>

        <label>Class:</label><br>
        <select id="class">
            <option value="fighter">Fighter</option>
            <option value="wizard">Wizard</option>
            <option value="rogue">Rogue</option>
            <option value="cleric">Cleric</option>
        </select><br><br>

        <label>Level (1–10):</label><br>
        <input type="number" id="level" value="1" min="1" max="10"><br><br>

        <label>Weapons:</label><br>
        <input type="text" id="weapons" value="Shortsword, Dagger"><br><br>

        <label>Armor:</label><br>
        <input type="text" id="armor" value="Leather Armor"><br><br>

        <label>Spells:</label><br>
        <input type="text" id="spells" value="Firebolt, Cure Wounds"><br><br>

        <label>Inventory:</label><br>
        <input type="text" id="inventory" value="Healing Potion x3, Torch"><br><br>

        <button onclick="startAdventure()">Begin Quest</button>
    </div>

    <div id="game">
        <h1 id="quest-title">Quest Loading...</h1>
        <div id="dm-narration"><strong>DM:</strong> Welcome, Elias...</div>
        <div class="combat-area">
            <div class="model-container">
                <div class="pixel-model" id="player-model"></div>
                <div class="stats-bar" id="player-stats"></div>
                <div class="health-bar"><div class="health-fill" id="player-hp-fill"></div></div>
            </div>
            <div class="model-container">
                <div class="pixel-model" id="enemy-model" style="display:none;"></div>
                <div class="stats-bar" id="enemy-stats"></div>
                <div class="health-bar" id="enemy-hp-bar" style="display:none;">
                    <div class="health-fill" id="enemy-hp-fill"></div>
                </div>
            </div>
        </div>
        <div id="story">The tale begins...</div>
        <div id="action-buttons"></div>
        <div id="dice" style="display:none;">
            <button onclick="rollAttack()">Attack (Weapon)</button>
            <p id="roll-result"></p>
        </div>
        <div id="quest-log">Progress: 0%</div>
    </div>

    <div id="death">
        You and your fellow warriors have fallen.<br>Rise up.
        <br><br>
        <button onclick="location.reload()">New Tale</button>
    </div>
</div>

<script>
let char = {};
let currentHP = 20;
let maxHP = 20;
let inCombat = false;
let playerTurn = true;
let enemy = { name: "", hp: 0, maxHp: 0 };

function startAdventure() {
    // Reset important values
    currentHP = 20;
    maxHP = 20;
    inCombat = false;

    char.race     = document.getElementById("race").value;
    char.class    = document.getElementById("class").value;
    char.level    = parseInt(document.getElementById("level").value) || 1;
    char.weapons  = document.getElementById("weapons").value.split(",").map(s=>s.trim()).filter(Boolean);
    char.armor    = document.getElementById("armor").value.trim() || "None";
    char.spells   = document.getElementById("spells").value.split(",").map(s=>s.trim()).filter(Boolean);
    char.inventory = document.getElementById("inventory").value.split(",").map(s=>s.trim()).filter(Boolean);

    // Calculate HP AFTER reading level/class
    maxHP = 15 + (char.level * 7) + (char.class === "fighter" ? 12 : 0);
    currentHP = maxHP;  // Make sure this runs AFTER maxHP is set

    // Debug
    console.log("Character created:", char);
    console.log("HP set to:", currentHP, "/", maxHP);

    renderPixelModel("player-model", char.race, true);
    document.getElementById("player-stats").textContent = `${char.race} ${char.class} Lv${char.level}  HP:${currentHP}/${maxHP}`;

    document.getElementById("creation").style.display = "none";
    document.getElementById("game").style.display = "block";
    document.getElementById("death").style.display = "none";

    dmSpeak(`Elias of Chicago, the mists part. You are a ${char.race} ${char.class}. Your journey begins now...`);
    updatePlayerHP();
    nextEncounter();
}

function dmSpeak(text) {
    document.getElementById("dm-narration").innerHTML += `<br><strong>DM:</strong> ${text}`;
    document.getElementById("dm-narration").scrollTop = document.getElementById("dm-narration").scrollHeight;
}

function updatePlayerHP() {
    const perc = Math.max(0, Math.min(100, (currentHP / maxHP) * 100));
    document.getElementById("player-hp-fill").style.width = perc + "%";
    document.getElementById("player-stats").textContent = `${char.race} ${char.class} Lv${char.level}  HP:${currentHP}/${maxHP}`;
    console.log("HP updated:", currentHP, perc + "%");
}

function renderPixelModel(id, race, isPlayer) {
    const el = document.getElementById(id);
    el.innerHTML = '';
    for (let i = 0; i < 256; i++) {
        const px = document.createElement("div");
        px.className = "px";
        el.appendChild(px);
    }
    // Head area
    for (let r=3; r<8; r++) for (let c=5; c<12; c++) el.children[r*16+c].className += " px-skin";
    // Hair
    for (let c=5; c<12; c++) el.children[2*16+c].className += " px-hair";
    // Body
    for (let r=8; r<13; r++) for (let c=4; c<13; c++) el.children[r*16+c].className += " px-clothes";
    // Legs
    for (let r=13; r<16; r++) for (let c=5; c<12; c++) el.children[r*16+c].className += " px-dark";
}

function nextEncounter() {
    document.getElementById("dice").style.display = "none";
    document.getElementById("action-buttons").innerHTML = "";
    dmSpeak("You continue your journey...");
    startCombat(); // For testing — change back to random logic later
}

function startCombat() {
    enemy.name = "Goblin Scout";
    enemy.maxHp = 18;
    enemy.hp = 18;

    document.getElementById("enemy-model").style.display = "block";
    document.getElementById("enemy-hp-bar").style.display = "block";
    updateEnemyHP();

    inCombat = true;
    playerTurn = true;

    dmSpeak(`A ${enemy.name} appears! What do you do?`);
    showCombatActions();
}

function showCombatActions() {
    document.getElementById("action-buttons").innerHTML = `
        <button onclick="startTurn('weapon')">Attack with Weapon</button>
        <button onclick="startTurn('spell')">Cast Spell</button>
        <button onclick="startTurn('potion')">Use Potion</button>
        <button onclick="attemptRun()">Run</button>
    `;
}

function startTurn(type) {
    if (type === 'potion') {
        const potionIndex = char.inventory.findIndex(i => i.toLowerCase().includes("potion"));
        if (potionIndex !== -1) {
            dmSpeak("You drink a healing potion...");
            currentHP = Math.min(maxHP, currentHP + 10);
            char.inventory.splice(potionIndex, 1);
            updatePlayerHP();
            playerTurn = false;
            setTimeout(enemyTurn, 800);
        } else {
            dmSpeak("No potions left!");
        }
        return;
    }

    document.getElementById("dice").style.display = "block";
    document.getElementById("action-buttons").innerHTML = "";
    document.getElementById("roll-result").textContent = `Roll d20 for ${type}...`;
    window.currentActionType = type;
}

function rollAttack() {
    if (!inCombat || !playerTurn) return;
    const roll = Math.floor(Math.random() * 20) + 1;
    let msg = `You roll ${roll} → `;

    if (roll <= 9) {
        msg += "miss!";
    } else {
        let dmg = roll - 9;
        if (roll === 20) dmg *= 2;
        enemy.hp -= dmg;
        msg += `hit for ${dmg} damage!`;
        document.getElementById("enemy-model").classList.add("attack");
        setTimeout(() => document.getElementById("enemy-model").classList.remove("attack"), 500);
        updateEnemyHP();

        if (enemy.hp <= 0) {
            dmSpeak(`The ${enemy.name} is defeated!`);
            endCombat();
            setTimeout(nextEncounter, 2000);
            return;
        }
    }

    document.getElementById("roll-result").textContent = msg;
    playerTurn = false;
    setTimeout(enemyTurn, 1000);
}

function enemyTurn() {
    const roll = Math.floor(Math.random() * 20) + 1;
    let msg = `Enemy rolls ${roll} → `;

    if (roll <= 9) {
        msg += "misses!";
    } else {
        let dmg = roll - 9;
        if (roll === 20) dmg *= 2;
        currentHP -= dmg;
        msg += `hits for ${dmg} damage!`;
        updatePlayerHP();

        if (currentHP <= 0) {
            document.getElementById("game").style.display = "none";
            document.getElementById("death").style.display = "flex";
            return;
        }
    }

    dmSpeak(msg);
    playerTurn = true;
    showCombatActions();
}

function attemptRun() {
    if (Math.random() < 0.6) {
        dmSpeak("You escape!");
        endCombat();
        setTimeout(nextEncounter, 1500);
    } else {
        dmSpeak("No escape! Enemy attacks.");
        playerTurn = false;
        enemyTurn();
    }
}

function updateEnemyHP() {
    const perc = Math.max(0, (enemy.hp / enemy.maxHp) * 100);
    document.getElementById("enemy-hp-fill").style.width = perc + "%";
    document.getElementById("enemy-stats").textContent = `${enemy.name} HP:${enemy.hp}/${enemy.maxHp}`;
}

function endCombat() {
    inCombat = false;
    document.getElementById("enemy-model").style.display = "none";
    document.getElementById("enemy-hp-bar").style.display = "none";
    document.getElementById("dice").style.display = "none";
    document.getElementById("action-buttons").innerHTML = "";
    document.getElementById("roll-result").textContent = "";
}

function restartGame() {
    location.reload();
}
</script>
</body>
</html>
