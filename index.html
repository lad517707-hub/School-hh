<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Horus Heresy – Legion Survival</title>
<style>
    body { margin:0; padding:0; background:#000; color:#eee; font-family:Arial, sans-serif; overflow:hidden; }
    #ui { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.7); padding:15px; border:1px solid #fff; z-index:10; }
    #canvas { display:block; cursor:crosshair; image-rendering:pixelated; }
    button, select { margin:5px; padding:8px; font-size:16px; }
    #objective { position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.7); padding:10px; z-index:5; display:none; font-size:16px; }
</style>
</head>
<body>

<div id="ui">
    <label>Choose Legion:</label><br>
    <select id="legionSelect">
        <option value="">Pick one</option>
        <option value="Dark Angels">Dark Angels</option>
        <option value="Emperor's Children">Emperor's Children</option>
        <option value="Iron Warriors">Iron Warriors</option>
        <option value="White Scars">White Scars</option>
        <option value="Space Wolves">Space Wolves</option>
        <option value="Imperial Fists">Imperial Fists</option>
        <option value="Night Lords">Night Lords</option>
        <option value="Blood Angels">Blood Angels</option>
        <option value="Iron Hands">Iron Hands</option>
        <option value="World Eaters">World Eaters</option>
        <option value="Ultramarines">Ultramarines</option>
        <option value="Death Guard">Death Guard</option>
        <option value="Thousand Sons">Thousand Sons</option>
        <option value="Sons of Horus">Sons of Horus</option>
        <option value="Word Bearers">Word Bearers</option>
        <option value="Salamanders">Salamanders</option>
        <option value="Raven Guard">Raven Guard</option>
        <option value="Alpha Legion">Alpha Legion</option>
    </select><br>
    <button onclick="startGame()">Deploy</button>
</div>

<canvas id="canvas" width="1400" height="900"></canvas>

<div id="objective">Click a marine to select → click destination to move<br>Click leader (bigger) → squad follows<br>Mouse wheel = zoom in/out (more detail when close)</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const LEGION_COLORS = {
    "Dark Angels": "#2e7d32",
    "Emperor's Children": "#7b1fa2",
    "Iron Warriors": "#616161",
    "White Scars": "#e0e0e0",
    "Space Wolves": "#90caf9",
    "Imperial Fists": "#ffeb3b",
    "Night Lords": "#0d47a1",
    "Blood Angels": "#c62828",
    "Iron Hands": "#212121",
    "World Eaters": "#b71c1c",
    "Ultramarines": "#1976d2",
    "Death Guard": "#558b2f",
    "Thousand Sons": "#283593",
    "Sons of Horus": "#2e7d32",
    "Word Bearers": "#880e4f",
    "Salamanders": "#1b5e20",
    "Raven Guard": "#263238",
    "Alpha Legion": "#00695c"
};

let playerColor = null;
let playerLegionName = "";
let playerUnits = [];
let selectedUnitIndex = null;
let enemies = [];
let machinePos = {x: 700, y: -1800};
let buttonActivated = false;
let zoom = 1;
let cameraX = 700;
let cameraY = 450;

function startGame() {
    const legion = document.getElementById('legionSelect').value;
    if (!legion) {
        alert("Pick a legion first!");
        return;
    }

    playerLegionName = legion;
    playerColor = LEGION_COLORS[legion] || "#888888";

    document.getElementById('ui').style.display = 'none';
    document.getElementById('objective').style.display = 'block';

    // Squad in center of view
    playerUnits = [];
    for (let i = 0; i < 11; i++) {
        playerUnits.push({
            x: 700 + (i - 5) * 35,
            y: 450 + (i % 3 - 1) * 35,
            destX: null,
            destY: null,
            hp: 100,
            isLeader: i === 5
        });
    }

    // Start enemies and loop
    spawnEnemies();
    requestAnimationFrame(gameLoop);
}

function drawUnits() {
    playerUnits.forEach((u, i) => {
        if (u.hp <= 0) return;

        const s = u.isLeader ? 18 : 12;

        // Armor body
        ctx.fillStyle = playerColor;
        ctx.beginPath();
        ctx.arc(u.x, u.y, s, 0, Math.PI * 2);
        ctx.fill();

        // Helmet
        ctx.fillStyle = "#eeeeee";
        ctx.beginPath();
        ctx.arc(u.x, u.y - s * 0.5, s * 0.6, 0, Math.PI * 2);
        ctx.fill();

        // Symbol when zoomed
        if (zoom > 1.3) {
            ctx.fillStyle = "#ffffff";
            ctx.font = `${s * 1.2}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("A", u.x, u.y); // placeholder symbol
        }

        if (u.isLeader) {
            ctx.strokeStyle = "#ffff99";
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(u.x, u.y, s * 1.3, 0, Math.PI * 2);
            ctx.stroke();
        }

        if (selectedUnitIndex === i) {
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(u.x, u.y, s * 1.2, 0, Math.PI * 2);
            ctx.stroke();
        }
    });
}

function drawEnemies() {
    enemies.forEach(e => {
        if (e.hp <= 0) return;
        ctx.fillStyle = '#800000';
        ctx.beginPath();
        ctx.arc(e.x, e.y, 14, 0, Math.PI * 2);
        ctx.fill();
    });
}

function moveUnits() {
    playerUnits.forEach(u => {
        if (u.hp <= 0 || !u.destX) return;
        const dx = u.destX - u.x;
        const dy = u.destY - u.y;
        const dist = Math.hypot(dx, dy);
        if (dist < 5) {
            u.destX = u.destY = null;
            return;
        }
        const speed = u.isLeader ? 2.8 : 2.4;
        u.x += dx / dist * speed;
        u.y += dy / dist * speed;
    });
}

function enemyAI() {
    enemies.forEach(e => {
        if (e.hp <= 0) return;
        let closest = null;
        let minDist = Infinity;
        playerUnits.forEach(p => {
            if (p.hp > 0) {
                const d = Math.hypot(p.x - e.x, p.y - e.y);
                if (d < minDist) {
                    minDist = d;
                    closest = p;
                }
            }
        });
        if (closest) {
            const dx = closest.x - e.x;
            const dy = closest.y - e.y;
            const dist = Math.hypot(dx, dy);
            if (dist < 30) {
                closest.hp -= 0.6; // melee damage
            } else {
                e.x += dx / dist * 1.2;
                e.y += dy / dist * 1.2;
            }
        }
    });
}

function playerCombat() {
    playerUnits.forEach(u => {
        if (u.hp <= 0) return;
        let closest = null;
        let minDist = Infinity;
        enemies.forEach(e => {
            if (e.hp > 0) {
                const d = Math.hypot(e.x - u.x, e.y - u.y);
                if (d < 120 && d < minDist) {
                    minDist = d;
                    closest = e;
                }
            }
        });
        if (closest) {
            ctx.strokeStyle = '#ff8800';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(u.x, u.y);
            ctx.lineTo(closest.x, closest.y);
            ctx.stroke();
            closest.hp -= 0.8;
        }
    });
}

function spawnEnemies() {
    setInterval(() => {
        if (buttonActivated) return;
        const num = Math.floor(Math.random() * 5) + 3;
        for (let i = 0; i < num; i++) {
            enemies.push({
                x: Math.random() * canvas.width,
                y: Math.random() * 200 - 300, // spawn above
                hp: 50 + Math.random() * 40
            });
        }
    }, 10000);
}

function checkActivation() {
    if (buttonActivated) return;
    if (playerUnits.some(u => u.hp > 0 && Math.hypot(u.x - machinePos.x, u.y - machinePos.y) < 80)) {
        buttonActivated = true;
        alert("Beam activated! Victory!");
    }
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Simple ground
    ctx.fillStyle = '#2e4d1a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Debug machine position
    ctx.fillStyle = '#880000';
    ctx.fillRect(650, 100, 100, 100);
    ctx.fillStyle = 'white';
    ctx.font = '20px Arial';
    ctx.fillText("MACHINE", 680, 150);

    drawUnits();
    drawEnemies();

    moveUnits();
    enemyAI();
    playerCombat();
    checkActivation();

    requestAnimationFrame(gameLoop);
}

canvas.addEventListener('click', e => {
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;

    let clicked = null;
    playerUnits.forEach((u, i) => {
        if (Math.hypot(clickX - u.x, clickY - u.y) < 20) clicked = i;
    });

    if (clicked !== null) {
        selectedUnitIndex = clicked;
    } else if (selectedUnitIndex !== null) {
        const u = playerUnits[selectedUnitIndex];
        u.destX = clickX;
        u.destY = clickY;
        if (u.isLeader) {
            playerUnits.forEach(other => {
                if (other !== u) {
                    other.destX = clickX + (Math.random() - 0.5) * 80;
                    other.destY = clickY + (Math.random() - 0.5) * 80;
                }
            });
        }
        selectedUnitIndex = null;
    }
});

canvas.addEventListener('wheel', e => {
    e.preventDefault();
    zoom += e.deltaY * -0.001;
    zoom = Math.max(0.5, Math.min(3, zoom));
});
</script>
</body>
</html>
