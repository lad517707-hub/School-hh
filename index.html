<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FALLOUT ECHOES - Storymode Adventure</title>
<style>
  body { margin:0; background:#000; overflow:hidden; font-family:'Courier New',monospace; color:#0f0; }
  #game { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); image-rendering:pixelated; box-shadow:0 0 40px #000; }
  #hud { position:absolute; top:8px; left:8px; font-size:14px; text-shadow:0 0 4px #000; pointer-events:none; color:#00ff88; z-index:10; }
  #msg { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:32px; color:#f00; background:rgba(0,0,0,0.8); opacity:0; transition:opacity 0.5s; pointer-events:none; font-weight:bold; text-shadow:0 0 8px #f00; z-index:20; }
  #story { position:absolute; bottom:20px; left:10%; width:80%; background:rgba(0,0,0,0.7); color:#0f0; padding:12px; font-size:15px; display:none; border:2px solid #0f0; pointer-events:auto; z-index:15; line-height:1.4; }
  #story button { background:#111; color:#0f0; border:1px solid #0f0; padding:6px 12px; margin:6px 4px; cursor:pointer; font-family:inherit; }
  #minimap { position:absolute; top:8px; right:8px; width:120px; height:88px; background:rgba(0,0,0,0.7); border:2px solid #0f0; display:none; image-rendering:pixelated; pointer-events:none; z-index:10; }
</style>
</head>
<body>
<canvas id="game" width="320" height="224"></canvas>
<div id="hud">POWER CELLS: <span id="count">0</span>/5 | HP: <span id="hp">100</span> | AMMO: <span id="ammo">20</span> | <span id="quest">Escape the Vault</span></div>
<canvas id="minimap" width="120" height="88"></canvas>
<div id="msg"></div>
<div id="story"></div>

<script>
// ────────────────────────────────
// FALLOUT ECHOES - Fixed & Finished
// ────────────────────────────────
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const minimapCtx = document.getElementById('minimap').getContext('2d');
canvas.style.width  = '960px';
canvas.style.height = '672px';

const TILE = 16;
const MAP_W = 25;
const MAP_H = 18;

const PAL = {
  bg: '#0a0a00', floor: '#3a2a10', wall: '#5a3a20',
  vaultWall: '#4a4a6a', vaultFloor: '#2a2a3a',
  wastelandFloor: '#8b5a2b', wastelandWall: '#6b3a1b',
  powerOff: '#ff6600', powerOn: '#00ff88',
  player: '#40c0c0', playerDark: '#208080',
  door: '#8b4513', bullet: '#ffff88',
  mutant: '#1a5c1a', raider: '#8b4513', ghoul: '#5c6b2f'
};

let player = { x: 2.5, y: 2.5, health: 100, ammo: 20, facing: 0 }; // 0=down, 1=right, 2=up, 3=left
let enemies = [];
let breakers = [];
let bullets = [];
let activated = 0;
let gameOver = false;
let won = false;
let flashlight = true;
let showMinimap = false;
let inWasteland = false;
let map = [];

const stories = [
  "Vault 101. Power failing. Find 5 fusion cells to open the vault door. Radiation levels rising.",
  "Cell acquired. Feral ghoul nearby — combat imminent.",
  "Vault structural integrity compromised. Move quickly, Vault Dweller.",
  "Raider ahead. 'Nice suit, vault boy. Hand it over.'",
  "All cells in place. Vault door opening… The surface awaits.",
  "Welcome to the Capital Wasteland. Radiation, mutants, raiders. Survive.",
  "You survived. For now. The wastes never truly end."
];

function generateMap(isVault = true) {
  inWasteland = !isVault;
  map = Array(MAP_H).fill().map(() => Array(MAP_W).fill('#'));

  // Create rooms
  for (let i = 0; i < 7; i++) {
    let rx = 2 + Math.floor(Math.random() * (MAP_W - 8));
    let ry = 2 + Math.floor(Math.random() * (MAP_H - 8));
    let rw = 4 + Math.floor(Math.random() * 6);
    let rh = 4 + Math.floor(Math.random() * 5);
    for (let y = ry; y < ry + rh && y < MAP_H; y++)
      for (let x = rx; x < rx + rw && x < MAP_W; x++)
        map[y][x] = '.';
  }

  // Connect with corridors
  for (let y = 1; y < MAP_H - 1; y++)
    for (let x = 1; x < MAP_W - 1; x++)
      if (Math.random() < 0.09 && map[y][x] === '#') map[y][x] = '.';

  breakers = [];
  enemies = [];
  bullets = [];

  // Objectives
  for (let i = 0; i < 5; i++) {
    let x, y;
    do { x = Math.floor(Math.random() * MAP_W); y = Math.floor(Math.random() * MAP_H); }
    while (map[y][x] !== '.');
    breakers.push({ x: x + 0.5, y: y + 0.5, active: false });
  }

  // Enemies
  let count = isVault ? 5 : 7;
  for (let i = 0; i < count; i++) {
    let x, y;
    do {
      x = Math.floor(Math.random() * MAP_W);
      y = Math.floor(Math.random() * MAP_H);
    } while (map[y][x] !== '.' || Math.hypot(x + 0.5 - player.x, y + 0.5 - player.y) < 5);
    let type = isVault
      ? (Math.random() < 0.6 ? 'ghoul' : 'raider')
      : (Math.random() < 0.65 ? 'mutant' : 'raider');
    enemies.push({
      x: x + 0.5, y: y + 0.5,
      type, health: type === 'mutant' ? 80 : 45,
      maxHealth: type === 'mutant' ? 80 : 45
    });
  }

  player.x = 2.5; player.y = 2.5;
  activated = 0;
  document.getElementById('count').textContent = 0;
  document.getElementById('hp').textContent = player.health;
  document.getElementById('ammo').textContent = player.ammo;
  document.getElementById('quest').textContent = isVault ? "Find 5 Fusion Cells" : "Find 5 Purifiers";
  gameOver = won = false;
  showStory(isVault ? 0 : 5);
}

function showMsg(text, color = '#0f0', duration = 1600) {
  const el = document.getElementById('msg');
  el.textContent = text;
  el.style.color = color;
  el.style.opacity = 1;
  setTimeout(() => el.style.opacity = 0, duration);
}

function showStory(id) {
  const div = document.getElementById('story');
  div.innerHTML = `<p>${stories[id] || stories[0]}</p>`;
  let btn = '';
  if (id === 1) btn = '<button onclick="choice(1,\'fight\')">Fight</button><button onclick="choice(1,\'run\')">Run</button>';
  else if (id === 3) btn = '<button onclick="choice(3,\'fight\')">Fight</button><button onclick="choice(3,\'talk\')">Talk</button><button onclick="choice(3,\'run\')">Run</button>';
  else if (id === 4) btn = '<button onclick="choice(4,\'enter\')">Enter the Wasteland</button>';
  else btn = '<button onclick="closeStory()">Continue</button>';
  div.innerHTML += btn;
  div.style.display = 'block';
}

function closeStory() { document.getElementById('story').style.display = 'none'; }

function choice(id, opt) {
  closeStory();
  if (id === 1) {
    player.health -= opt === 'fight' ? 22 : 10;
    showMsg(opt === 'fight' ? "Ghoul defeated. -22 HP" : "Escaped. -10 HP");
  } else if (id === 3) {
    if (opt === 'fight') { player.health -= 32; player.ammo -= 5; showMsg("Raider killed. -32 HP, -5 ammo"); }
    else if (opt === 'talk') { showMsg("You talked him down. No damage."); }
    else { player.health -= 14; showMsg("Escaped. -14 HP"); }
  } else if (id === 4) {
    generateMap(false);
  }
  document.getElementById('hp').textContent = Math.max(0, player.health);
  if (player.health <= 0) {
    gameOver = true;
    showMsg("YOU DIED", "#f00", 9999);
  }
}

const keys = {};
window.addEventListener('keydown', e => {
  const k = e.key.toLowerCase();
  keys[k] = true;
  if (k === 'e') tryActivate();
  if (k === 'f' && !e.repeat) shoot();
});
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

function tryActivate() {
  for (let b of breakers) {
    if (!b.active && Math.hypot(b.x - player.x, b.y - player.y) < 1.3) {
      b.active = true;
      activated++;
      document.getElementById('count').textContent = activated;
      showMsg("Cell Activated", "#00ff88");
      if (activated >= 5) {
        won = true;
        showStory(4);
      }
      return;
    }
  }
  showMsg("Nothing nearby to use.");
}

function shoot() {
  if (player.ammo <= 0) { showMsg("No ammo!", "#ff8800"); return; }
  player.ammo--;
  document.getElementById('ammo').textContent = player.ammo;
  const angles = [0, Math.PI/2, Math.PI, -Math.PI/2];
  bullets.push({
    x: player.x, y: player.y,
    vx: Math.cos(angles[player.facing]) * 0.4,
    vy: Math.sin(angles[player.facing]) * 0.4,
    life: 50
  });
}

function isWalkable(x, y) {
  const tx = Math.floor(x), ty = Math.floor(y);
  return tx >= 0 && tx < MAP_W && ty >= 0 && ty < MAP_H && map[ty][tx] !== '#';
}

function update() {
  if (gameOver || won) return;

  // Movement (fixed - allows smooth diagonal & proper facing)
  let dx = 0, dy = 0;
  if (keys['w'] || keys['arrowup'])    { dy -= 0.1; player.facing = 2; }
  if (keys['s'] || keys['arrowdown'])  { dy += 0.1; player.facing = 0; }
  if (keys['a'] || keys['arrowleft'])  { dx -= 0.1; player.facing = 3; }
  if (keys['d'] || keys['arrowright']) { dx += 0.1; player.facing = 1; }

  // Normalize diagonal speed
  if (dx !== 0 && dy !== 0) { dx *= 0.707; dy *= 0.707; }

  let nx = player.x + dx, ny = player.y + dy;
  if (isWalkable(nx, player.y)) player.x = nx;
  if (isWalkable(player.x, ny)) player.y = ny;

  // Toggle flashlight & minimap (debounced via keyup)
  if (keys[' ']) { keys[' '] = false; flashlight = !flashlight; }
  if (keys['shift']) { keys['shift'] = false; showMinimap = !showMinimap; document.getElementById('minimap').style.display = showMinimap ? 'block' : 'none'; }

  // Update bullets
  bullets = bullets.filter(b => {
    b.x += b.vx; b.y += b.vy; b.life--;
    if (b.life <= 0 || !isWalkable(b.x, b.y)) return false;
    for (let e of enemies) {
      if (e.health > 0 && Math.hypot(e.x - b.x, e.y - b.y) < 0.7) {
        e.health -= 28;
        if (e.health <= 0) showMsg(`${e.type.toUpperCase()} KILLED`, "#ff4444");
        return false;
      }
    }
    return true;
  });

  // Enemy movement & attack
  enemies.forEach(e => {
    if (e.health <= 0) return;
    let dist = Math.hypot(e.x - player.x, e.y - player.y);
    if (dist < 6) {
      let ang = Math.atan2(player.y - e.y, player.x - e.x);
      let nx = e.x + Math.cos(ang) * 0.065;
      let ny = e.y + Math.sin(ang) * 0.065;
      if (isWalkable(nx, e.y)) e.x = nx;
      if (isWalkable(e.x, ny)) e.y = ny;
    }
    if (dist < 1.2) {
      player.health -= inWasteland ? 12 : 8;
      document.getElementById('hp').textContent = Math.max(0, player.health);
      showMsg(`Hit! -${inWasteland ? 12 : 8} HP`, "#ff4444", 700);
      if (player.health <= 0) {
        gameOver = true;
        showMsg("YOU DIED", "#f00", 9999);
      }
    }
  });
}

function drawPlayer() {
  const px = player.x * TILE - camX;
  const py = player.y * TILE - camY;
  // Vault suit body
  ctx.fillStyle = PAL.player;
  ctx.fillRect(px - 6, py - 14, 12, 18);
  // Arms
  ctx.fillStyle = PAL.playerDark;
  ctx.fillRect(px - 8, py - 12, 4, 10);
  ctx.fillRect(px + 4, py - 12, 4, 10);
  // Head
  ctx.fillStyle = '#d0d0a0';
  ctx.fillRect(px - 4, py - 20, 8, 8);
  // Pip-boy glow (right arm)
  ctx.fillStyle = '#88ff88';
  ctx.fillRect(px + 3, py - 10, 5, 5);
}

function drawEnemy(e) {
  const sx = e.x * TILE - camX;
  const sy = e.y * TILE - camY;
  if (e.type === 'mutant') {
    ctx.fillStyle = PAL.mutant;
    ctx.fillRect(sx - 9, sy - 18, 18, 28); // big body
    ctx.fillStyle = '#0f3f0f';
    ctx.fillRect(sx - 5, sy - 22, 10, 8); // head
  } else if (e.type === 'ghoul') {
    ctx.fillStyle = PAL.ghoul;
    ctx.fillRect(sx - 6, sy - 16, 12, 22);
    ctx.fillStyle = '#3a4a1a';
    ctx.fillRect(sx - 4, sy - 20, 8, 8);
  } else { // raider
    ctx.fillStyle = PAL.raider;
    ctx.fillRect(sx - 7, sy - 15, 14, 24);
    ctx.fillStyle = '#5a2a0a';
    ctx.fillRect(sx - 5, sy - 19, 10, 9);
  }
}

let camX, camY;

function render() {
  ctx.fillStyle = inWasteland ? '#1a0f00' : PAL.bg;
  ctx.fillRect(0, 0, 320, 224);

  camX = player.x * TILE - 160;
  camY = player.y * TILE - 112;

  // Tiles
  for (let y = 0; y < MAP_H; y++) {
    for (let x = 0; x < MAP_W; x++) {
      let sx = x * TILE - camX;
      let sy = y * TILE - camY;
      if (sx > -TILE && sx < 340 && sy > -TILE && sy < 250) {
        ctx.fillStyle = map[y][x] === '#' ?
          (inWasteland ? PAL.wastelandWall : PAL.vaultWall) :
          (inWasteland ? PAL.wastelandFloor : PAL.vaultFloor);
        ctx.fillRect(sx, sy, TILE, TILE);
      }
    }
  }

  // Vault door
  if (won && !inWasteland) {
    let dx = MAP_W - 2, dy = Math.floor(MAP_H / 2);
    let sx = dx * TILE - camX, sy = dy * TILE - camY;
    ctx.fillStyle = PAL.door;
    ctx.fillRect(sx - 6, sy - 12, 28, 40);
  }

  // Objectives
  breakers.forEach(b => {
    let sx = b.x * TILE - camX;
    let sy = b.y * TILE - camY;
    ctx.fillStyle = b.active ? PAL.powerOn : PAL.powerOff;
    ctx.fillRect(sx - 5, sy - 5, 10, 10);
  });

  // Enemies
  enemies.forEach(e => { if (e.health > 0) drawEnemy(e); });

  // Bullets
  bullets.forEach(b => {
    let sx = b.x * TILE - camX;
    let sy = b.y * TILE - camY;
    ctx.fillStyle = PAL.bullet;
    ctx.fillRect(sx - 2, sy - 2, 4, 4);
  });

  // Player on top
  drawPlayer();

  // Lighting
  if (flashlight) {
    let grad = ctx.createRadialGradient(160, 112, 0, 160, 112, 140);
    grad.addColorStop(0, 'rgba(255,220,140,0.4)');
    grad.addColorStop(0.7, 'rgba(160,120,60,0.1)');
    grad.addColorStop(1, 'rgba(0,0,0,0.97)');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, 320, 224);
  } else {
    ctx.fillStyle = 'rgba(0,0,0,0.94)';
    ctx.fillRect(0, 0, 320, 224);
  }

  // Minimap
  if (showMinimap) {
    minimapCtx.fillStyle = '#000';
    minimapCtx.fillRect(0, 0, 120, 88);
    for (let y = 0; y < MAP_H; y++)
      for (let x = 0; x < MAP_W; x++) {
        minimapCtx.fillStyle = map[y][x] === '#' ? '#444' : inWasteland ? '#6b4e2f' : '#1f1f3a';
        minimapCtx.fillRect(x * 4.8, y * 4.8, 4.8, 4.8);
      }
    minimapCtx.fillStyle = '#0f0';
    minimapCtx.fillRect(player.x * 4.8 - 3, player.y * 4.8 - 3, 9, 9);
  }
}

function loop() {
  update();
  render();
  requestAnimationFrame(loop);
}

generateMap(true);
loop();

// Help text
setTimeout(() => {
  if (!gameOver && !won)
    showMsg("WASD / Arrows = Move • E = Use • F = Shoot • SPACE = Light • SHIFT = Map", "#88ffaa", 7000);
}, 3000);
</script>

<h3 style="text-align:center; color:#0f0; margin:20px; font-family:Courier New;">
  Fallout Echoes – Elias Edition<br>
  WASD / Arrows = Move  •  E = Interact  •  F = Shoot  •  SPACE = Flashlight  •  SHIFT = Minimap
</h3>
</body>
</html>
