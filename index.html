<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Office Game</title>
<style>
  body { margin: 0; background: black; overflow: hidden; }
  canvas { display: block; margin: auto; background: black; }
</style>
</head>
<body>

<canvas id="game" width="640" height="480"></canvas>

<script>
/* =======================
   SETUP
======================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const keys = {};
document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

/* =======================
   LOAD IMAGES (FIXED)
======================= */
const images = {};
let imagesLoaded = 0;
const totalImages = 8;

const load = src => {
  const img = new Image();
  img.onload = () => {
    imagesLoaded++;
    if (imagesLoaded === totalImages) {
      requestAnimationFrame(update); // START GAME ONLY AFTER LOAD
    }
  };
  img.onerror = () => console.error("Failed to load:", src);
  img.src = src;
  return img;
};

images.office = load("office.png");
images.playerNormal = load("player_normal.png");
images.playerGun = load("player_gun.png");
images.playerAttack = load("player_attack.png");
images.npc = load("npc.png");
images.monster = load("monster.png");
images.giga = load("giga_monster.png");
images.caught = load("caught_screen.png");

/* =======================
   GAME STATE
======================= */
const GAME_PLAYING = 0;
const GAME_CAUGHT = 1;
let gameState = GAME_PLAYING;

/* =======================
   PLAYER
======================= */
const player = {
  x: 100,
  y: 100,
  w: 24,
  h: 24,
  speed: 2,
  hasGun: false,
  attacking: false,
  cooldown: 0
};

/* =======================
   WALL COLLISION (SAFE)
======================= */
function isWall(x, y) {
  if (x < 0 || y < 0 || x >= canvas.width || y >= canvas.height) return true;
  try {
    const data = ctx.getImageData(x, y, 1, 1).data;
    const [r, g, b] = data;
    return (r === 255 && g === 255 && b === 0) ||
           (r === 139 && g === 69 && b === 19);
  } catch {
    return false;
  }
}

/* =======================
   NPCs
======================= */
class NPC {
  constructor(x, y, id) {
    this.x = x;
    this.y = y;
    this.id = id;
    this.alive = true;
  }
  draw() {
    if (this.alive) ctx.drawImage(images.npc, this.x, this.y);
  }
}

const npcs = [];
for (let i = 0; i < 20; i++) {
  npcs.push(new NPC(100 + i * 28, 360, i + 1));
}

/* =======================
   MONSTERS
======================= */
class Monster {
  constructor(x, y, id) {
    this.x = x;
    this.y = y;
    this.id = id;
    this.alive = true;
  }
  draw() {
    if (this.alive) ctx.drawImage(images.monster, this.x, this.y);
  }
}

const monsters = [
  new Monster(400, 200, "MX-01"),
  new Monster(440, 200, "MX-02")
];

/* =======================
   GIGA MONSTERS
======================= */
class GigaMonster {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.hits = 2;
    this.speed = 0.7;
    this.alive = true;
  }
  chase() {
    const dx = player.x - this.x;
    const dy = player.y - this.y;
    const d = Math.hypot(dx, dy);
    if (d > 0) {
      this.x += (dx / d) * this.speed;
      this.y += (dy / d) * this.speed;
    }
  }
  draw() {
    if (this.alive) ctx.drawImage(images.giga, this.x, this.y);
  }
}

const gigas = [ new GigaMonster(500, 100) ];

/* =======================
   CAUGHT SEQUENCE
======================= */
let pan = 0;
let fade = 0;

/* =======================
   MAIN LOOP
======================= */
function update() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(images.office, 0, 0);

  if (gameState === GAME_PLAYING) {

    let dx = 0, dy = 0;
    if (keys.w) dy -= player.speed;
    if (keys.s) dy += player.speed;
    if (keys.a) dx -= player.speed;
    if (keys.d) dx += player.speed;

    if (!isWall(player.x + dx, player.y)) player.x += dx;
    if (!isWall(player.x, player.y + dy)) player.y += dy;

    player.hasGun = keys["1"];
    player.attacking = player.hasGun && keys[" "];

    if (player.attacking && player.cooldown <= 0) {
      player.cooldown = 20;

      monsters.forEach(m => {
        if (m.alive && Math.hypot(m.x - player.x, m.y - player.y) < 40) {
          m.alive = false;
        }
      });

      gigas.forEach(g => {
        if (g.alive && Math.hypot(g.x - player.x, g.y - player.y) < 40) {
          g.hits--;
          if (g.hits <= 0) g.alive = false;
        }
      });
    }

    if (player.cooldown > 0) player.cooldown--;

    gigas.forEach(g => {
      if (g.alive) {
        g.chase();
        if (Math.hypot(g.x - player.x, g.y - player.y) < 16) {
          gameState = GAME_CAUGHT;
        }
      }
    });

    const sprite =
      player.attacking ? images.playerAttack :
      player.hasGun ? images.playerGun :
      images.playerNormal;

    ctx.drawImage(sprite, player.x, player.y);

    npcs.forEach(n => n.draw());
    monsters.forEach(m => m.draw());
    gigas.forEach(g => g.draw());

  } else {
    ctx.drawImage(images.caught, 0, -pan);
    pan += 0.3;
    fade += 1;
    ctx.fillStyle = `rgba(0,0,0,${fade / 255})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  requestAnimationFrame(update);
}

/* =======================
   NPC ID CHECK
======================= */
document.addEventListener("keydown", e => {
  if (e.key.toLowerCase() === "r") {
    const npc = npcs.find(n => n.alive);
    console.log(npc ? "NPC ID: " + npc.id : "No NPCs left");
  }
});
</script>

</body>
</html>
