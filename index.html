<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>School Blackout - Pixel Horror</title>
<style>
  body {
    margin: 0;
    padding: 0;
    height: 100vh;
    background: #000;
    overflow: hidden;
    font-family: 'Courier New', Courier, monospace;
    color: #0f0;
    image-rendering: pixelated;
  }
  #game {
    position: relative;
    width: 100%;
    height: 100%;
  }
  #canvas {
    image-rendering: pixelated;
    width: 100%;
    height: 100%;
    background: #111;
  }
  #ui {
    position: absolute;
    top: 10px;
    left: 10px;
    color: #0f0;
    font-size: 18px;
    text-shadow: 0 0 5px #0f0;
    pointer-events: none;
  }
  #message {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 60px;
    color: red;
    text-shadow: 0 0 20px red;
    background: rgba(0,0,0,0.7);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.4s;
  }
  #jumpscare {
    position: absolute;
    inset: 0;
    background: #f00 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><text x="50%" y="50%" font-size="120" text-anchor="middle" dominant-baseline="middle" fill="black">GET OUT</text></svg>') center/80% no-repeat;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s;
  }
  button {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 15px 30px;
    font-size: 24px;
    background: #222;
    color: #0f0;
    border: 3px solid #0f0;
    cursor: pointer;
    z-index: 10;
  }
</style>
</head>
<body>

<div id="game">
  <canvas id="canvas"></canvas>
  <div id="ui">Breakers: <span id="count">0</span>/5</div>
  <div id="message">GAME OVER</div>
  <div id="jumpscare"></div>
</div>

<script>
// ────────────────────────────────────────────────
// CONFIG
// ────────────────────────────────────────────────
const TILE = 40;              // pixel size per tile
const MAP_W = 25;             // tiles wide
const MAP_H = 18;             // tiles tall
const FLASHLIGHT_RADIUS = 4;  // tiles

const map = [
  "#########################",
  "#.......................#",
  "#.###.###.###.###.###...#",
  "#.......................#",
  "#.###.###.###.###.###...#",
  "#.......................#",
  "#.###.###.###.###.###...#",
  "#.......................#",
  "#.......................#",
  "#.B.....B.....B.........#",
  "#.......................#",
  "#.....B...........B.....#",
  "#.......................#",
  "#.......................#",
  "#.......................#",
  "#.......................#",
  "#.......................#",
  "#########################"
];

// B = breaker location

// ────────────────────────────────────────────────
// SETUP
// ────────────────────────────────────────────────
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = MAP_W * TILE;
canvas.height = MAP_H * TILE;

let player = { x: 2, y: 2, dir: "down" };
let monster = { x: 12, y: 8, active: false, chaseTimer: 0 };
let breakers = [];
let activated = 0;
let gameOver = false;
let won = false;

// Find breaker positions
for (let y = 0; y < MAP_H; y++) {
  for (let x = 0; x < MAP_W; x++) {
    if (map[y][x] === "B") {
      breakers.push({x, y, active: false});
    }
  }
}

const keys = {};
window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup",   e => keys[e.key.toLowerCase()] = false);

// ────────────────────────────────────────────────
// GAME LOOP
// ────────────────────────────────────────────────
function loop() {
  if (gameOver || won) return;

  update();
  render();

  requestAnimationFrame(loop);
}

function update() {
  // Player movement
  let nx = player.x, ny = player.y;

  if (keys["w"] || keys["arrowup"])    ny--;
  if (keys["s"] || keys["arrowdown"])  ny++;
  if (keys["a"] || keys["arrowleft"])  nx--;
  if (keys["d"] || keys["arrowright"]) nx++;

  if (nx !== player.x || ny !== player.y) {
    if (isWalkable(nx, ny)) {
      player.x = nx;
      player.y = ny;
    }
  }

  // Check breaker interaction
  for (let b of breakers) {
    if (!b.active && Math.abs(b.x - player.x) <= 1 && Math.abs(b.y - player.y) <= 1) {
      if (Math.random() < 0.06) { // ~6% chance per frame when near
        b.active = true;
        activated++;
        document.getElementById("count").textContent = activated;

        if (activated >= 5) {
          won = true;
          showMessage("POWER RESTORED\nESCAPE THE SCHOOL!", "#0f0");
        } else {
          showMessage("BREAKER ACTIVATED!", "#0f0", 1200);
        }
      }
    }
  }

  // Monster logic (simple chase when player visible)
  if (isInFlashlight(monster.x, monster.y)) {
    monster.active = true;
  }

  if (monster.active) {
    monster.chaseTimer++;
    if (monster.chaseTimer > 25) { // move every ~0.4s
      monster.chaseTimer = 0;

      let dx = player.x - monster.x;
      let dy = player.y - monster.y;

      if (Math.abs(dx) > Math.abs(dy)) {
        let nx = monster.x + Math.sign(dx);
        if (isWalkable(nx, monster.y)) monster.x = nx;
      } else {
        let ny = monster.y + Math.sign(dy);
        if (isWalkable(monster.x, ny)) monster.y = ny;
      }
    }

    // Caught!
    if (monster.x === player.x && monster.y === player.y) {
      jumpscare();
    }
  }
}

function isWalkable(x, y) {
  if (x < 0 || x >= MAP_W || y < 0 || y >= MAP_H) return false;
  return map[y][x] !== "#";
}

function isInFlashlight(mx, my) {
  const dx = mx - player.x;
  const dy = my - player.y;
  return Math.sqrt(dx*dx + dy*dy) <= FLASHLIGHT_RADIUS;
}

function jumpscare() {
  gameOver = true;
  document.getElementById("jumpscare").style.opacity = 1;
  document.getElementById("message").style.color = "red";
  document.getElementById("message").textContent = "YOU DIED";
  document.getElementById("message").style.opacity = 1;

  // Fake scream sound (browser beep)
  try {
    const audio = new AudioContext();
    const osc = audio.createOscillator();
    osc.type = "sawtooth";
    osc.frequency.setValueAtTime(180, audio.currentTime);
    osc.connect(audio.destination);
    osc.start();
    osc.stop(audio.currentTime + 0.4);
  } catch(e){}

  setTimeout(() => {
    document.getElementById("jumpscare").style.opacity = 0;
  }, 800);
}

function showMessage(text, color = "#fff", duration = 3000) {
  const msg = document.getElementById("message");
  msg.textContent = text;
  msg.style.color = color;
  msg.style.opacity = 1;
  setTimeout(() => { msg.style.opacity = 0; }, duration);
}

function render() {
  ctx.fillStyle = "#0a0a0a";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Draw map (walls & floor)
  for (let y = 0; y < MAP_H; y++) {
    for (let x = 0; x < MAP_W; x++) {
      const tile = map[y][x];
      const px = x * TILE;
      const py = y * TILE;

      if (tile === "#") {
        ctx.fillStyle = "#333";
        ctx.fillRect(px, py, TILE, TILE);
        ctx.strokeStyle = "#222";
        ctx.strokeRect(px, py, TILE, TILE);
      } else {
        // subtle floor
        ctx.fillStyle = "#111";
        ctx.fillRect(px, py, TILE, TILE);
      }
    }
  }

  // Draw breakers
  ctx.fillStyle = "#ff8800";
  for (let b of breakers) {
    if (!b.active) {
      ctx.fillRect(b.x*TILE + 8, b.y*TILE + 8, TILE-16, TILE-16);
    }
  }

  // Draw player (simple pixel guy)
  ctx.fillStyle = "#0f0";
  ctx.fillRect(player.x*TILE + 10, player.y*TILE + 6, TILE-20, TILE-12); // body
  ctx.fillRect(player.x*TILE + 14, player.y*TILE + 2, TILE-28, TILE-20); // head

  // Draw monster (if active)
  if (monster.active) {
    ctx.fillStyle = "#800";
    ctx.fillRect(monster.x*TILE + 4, monster.y*TILE + 4, TILE-8, TILE-8);
  }

  // Flashlight effect (dark overlay + circle reveal)
  ctx.save();
  ctx.globalCompositeOperation = "destination-out";
  ctx.beginPath();
  ctx.arc(
    (player.x + 0.5) * TILE,
    (player.y + 0.5) * TILE,
    FLASHLIGHT_RADIUS * TILE * 1.4,
    0, Math.PI*2
  );
  ctx.fill();
  ctx.restore();

  // Final dark vignette
  const grad = ctx.createRadialGradient(
    (player.x+0.5)*TILE, (player.y+0.5)*TILE,
    FLASHLIGHT_RADIUS*TILE*0.8,
    (player.x+0.5)*TILE, (player.y+0.5)*TILE,
    FLASHLIGHT_RADIUS*TILE*2.5
  );
  grad.addColorStop(0, "rgba(0,0,0,0)");
  grad.addColorStop(0.6, "rgba(0,0,0,0.7)");
  grad.addColorStop(1, "rgba(0,0,0,1)");
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

// Start game
showMessage("Find and activate 5 breakers...\nDon't let it catch you!", "#0f0", 5000);
loop();
</script>

</body>
</html>
