<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Office Game</title>
<style>
  body { margin: 0; background: black; overflow: hidden; }
  canvas { display: block; margin: auto; background: #111; }
</style>
</head>
<body>

<canvas id="game" width="640" height="480"></canvas>

<script>
/* =======================
   SETUP
======================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const keys = {};
document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

/* =======================
   IMAGE LOADER (SAFE)
======================= */
function loadImage(src) {
  const img = new Image();
  img.src = src;
  img.loaded = false;
  img.onload = () => img.loaded = true;
  img.onerror = () => console.warn("Missing image:", src);
  return img;
}

const images = {
  office: loadImage("office.png"),
  playerNormal: loadImage("player_normal.png"),
  playerGun: loadImage("player_gun.png"),
  playerAttack: loadImage("player_attack.png"),
  npc: loadImage("npc.png"),
  monster: loadImage("monster.png"),
  giga: loadImage("giga_monster.png"),
  caught: loadImage("caught_screen.png")
};

/* =======================
   GAME STATE
======================= */
const GAME_PLAYING = 0;
const GAME_CAUGHT = 1;
let gameState = GAME_PLAYING;

/* =======================
   PLAYER
======================= */
const player = {
  x: 100,
  y: 100,
  w: 24,
  h: 24,
  speed: 2,
  hasGun: false,
  attacking: false,
  cooldown: 0
};

/* =======================
   WALL COLLISION (DISABLED SAFELY)
======================= */
function isWall() {
  return false; // disable until map collision exists
}

/* =======================
   NPCs
======================= */
class NPC {
  constructor(x, y, id) {
    this.x = x;
    this.y = y;
    this.id = id;
    this.alive = true;
  }
  draw() {
    if (!this.alive) return;
    if (images.npc.loaded)
      ctx.drawImage(images.npc, this.x, this.y);
    else {
      ctx.fillStyle = "cyan";
      ctx.fillRect(this.x, this.y, 16, 16);
    }
  }
}

const npcs = [];
for (let i = 0; i < 20; i++) {
  npcs.push(new NPC(40 + i * 28, 400, i + 1));
}

/* =======================
   MONSTERS
======================= */
class Monster {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.alive = true;
  }
  draw() {
    if (!this.alive) return;
    if (images.monster.loaded)
      ctx.drawImage(images.monster, this.x, this.y);
    else {
      ctx.fillStyle = "red";
      ctx.fillRect(this.x, this.y, 18, 18);
    }
  }
}

const monsters = [
  new Monster(400, 200),
  new Monster(440, 200)
];

/* =======================
   GIGA MONSTER
======================= */
class GigaMonster {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.hits = 2;
    this.speed = 0.7;
    this.alive = true;
  }
  chase() {
    const dx = player.x - this.x;
    const dy = player.y - this.y;
    const d = Math.hypot(dx, dy);
    if (d > 0) {
      this.x += (dx / d) * this.speed;
      this.y += (dy / d) * this.speed;
    }
  }
  draw() {
    if (!this.alive) return;
    if (images.giga.loaded)
      ctx.drawImage(images.giga, this.x, this.y);
    else {
      ctx.fillStyle = "purple";
      ctx.fillRect(this.x, this.y, 28, 28);
    }
  }
}

const gigas = [ new GigaMonster(500, 100) ];

/* =======================
   MAIN LOOP
======================= */
function update() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Background
  if (images.office.loaded) {
    ctx.drawImage(images.office, 0, 0);
  } else {
    ctx.fillStyle = "#222";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  if (gameState === GAME_PLAYING) {
    let dx = 0, dy = 0;
    if (keys.w) dy -= player.speed;
    if (keys.s) dy += player.speed;
    if (keys.a) dx -= player.speed;
    if (keys.d) dx += player.speed;

    player.x += dx;
    player.y += dy;

    player.hasGun = keys["1"];
    player.attacking = player.hasGun && keys[" "];

    if (player.attacking && player.cooldown <= 0) {
      player.cooldown = 20;

      monsters.forEach(m => {
        if (m.alive && Math.hypot(m.x - player.x, m.y - player.y) < 40) {
          m.alive = false;
        }
      });

      gigas.forEach(g => {
        if (g.alive && Math.hypot(g.x - player.x, g.y - player.y) < 40) {
          g.hits--;
          if (g.hits <= 0) g.alive = false;
        }
      });
    }

    if (player.cooldown > 0) player.cooldown--;

    gigas.forEach(g => {
      if (g.alive) {
        g.chase();
        if (Math.hypot(g.x - player.x, g.y - player.y) < 16) {
          gameState = GAME_CAUGHT;
        }
      }
    });

    // Player draw
    ctx.fillStyle = player.attacking ? "yellow" : player.hasGun ? "orange" : "white";
    ctx.fillRect(player.x, player.y, player.w, player.h);

    npcs.forEach(n => n.draw());
    monsters.forEach(m => m.draw());
    gigas.forEach(g => g.draw());

  } else {
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "white";
    ctx.font = "32px sans-serif";
    ctx.fillText("CAUGHT", 260, 240);
  }

  requestAnimationFrame(update);
}

/* =======================
   START GAME
======================= */
requestAnimationFrame(update);
</script>

</body>
</html>
